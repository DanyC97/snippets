

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>sphinx.environment &mdash; Snippets 1 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../../_static/favicon-penn.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="Snippets 1 documentation" href="../../index.html"/>
        <link rel="up" title="Module code" href="../index.html"/> 

  
  <script src="../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../index.html" class="icon icon-home"> Snippets
          

          
          </a>

          
            
            
              <div class="version">
                1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <p class="caption"><span class="caption-text">Table of Contents</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../cs-bash-commands.html">1. bash-commands</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#escaping-single-quotes-a-mess">1.1. Escaping single quotes (a mess...)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#using-rename-command">1.2. Using rename command</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#rename-files-with-suffix-or-prefix">1.2.1. Rename files with suffix or prefix</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#regexp-syntax-with-rename">1.2.2. regexp syntax with rename</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#random-handy-snippets">1.3. Random handy snippets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#replace-whitespace-with-newline-in-sed">1.4. replace whitespace with newline in sed</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#what-if-multiple-line-is-spanned">1.4.1. What if multiple line is spanned?</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#check-running-processes">1.5. check running processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#nohup-vs-disown-vs">1.6. nohup vs disown vs &amp;</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#moving-and-copying">1.7. Moving and copying</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#scp-user">1.7.1. scp user</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#rsync">1.7.2. rsync</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-bash-commands.html#what-a-does">1.7.2.1. What <code class="docutils literal"><span class="pre">-a</span></code> does</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#find">1.8. find</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#note-find-vs-locate">1.8.1. Note: <strong>find</strong> vs <strong>locate</strong></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#command-vs-command-use-latter">1.9. ``command`` vs $(command) (use latter)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#ls-tricks">1.10. ls tricks</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#ls-recursively-use-find">1.10.1. ls recursively (use <em>find</em>)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#show-only-symbolic-links-alias-lssym">1.10.2. show only symbolic links (<strong>alias lssym</strong>)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#print-timestamp">1.11. print timestamp</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#open-image-xdg-open-image-png">1.12. open image ($xdg-open image.png)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#options-with-less-ongoing">1.13. Options with <strong>less</strong> (ongoing)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#history-w-o-line-numbers">1.14. history w/o line-numbers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#awk-one-liners">1.15. awk (one-liners)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#when-xargs-is-needed">1.16. When xargs is needed</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#get-computer-info">1.17. Get computer info</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#mogrify">1.18. mogrify</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#pipe-dreams-xargs-exec-in-find">1.19. Pipe dreams (xargs, -exec in find)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#grep">1.20. Grep</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#grep-recursively">1.20.1. grep recursively</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#to-grep-a-string-pipe-output-of-echo">1.20.2. To grep a string, pipe output of echo</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#d-not-supported-in-linux-grep-as-default-seems-like">1.20.3. d not supported in linux grep as default...seems like</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#just-use-double-quotes-for-regex-query">1.20.4. just use double-quotes for regex query</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#selecting-n-th-line-or-word-using-sed-and-awk">1.21. Selecting n-th line or word using sed and awk</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#use-xargs-to-execute-a-command-once-per-line-of-piped-input">1.22. Use xargs to execute a command once per line of piped input</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#run-same-command-multiple-times-for-loop">1.23. Run same command multiple times (for loop)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#sed-demos">1.24. sed demos</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#git">1.25. git</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-commands.html#change-author-name">1.25.1. change author name</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-commands.html#clipboard-with-xclip">1.26. clipboard with xclip</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-bash-scripts.html">2. bash-scripts</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#overflow-topics">2.1. Overflow topics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-scripts.html#check-file-existance">2.1.1. Check file existance</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#simple-loop-for-python">2.2. Simple loop for python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#qsub">2.3. qsub</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-scripts.html#my-old-qsub-approach">2.3.1. my old qsub approach</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-bash-scripts.html#slave-script">2.3.1.1. slave script</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-bash-scripts.html#minimalist-call">2.3.1.2. minimalist call</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-bash-scripts.html#master-script">2.3.1.3. master script</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-scripts.html#qsub-run">2.3.2. qsub-run</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#place-exit-1-to-end-script">2.4. place exit 1 to end script</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#style-guide-and-conventions">2.5. Style-guide and conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#arrays">2.6. arrays</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-scripts.html#expanding-indices">2.6.1. Expanding indices</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-bash-scripts.html#practical-example">2.6.2. practical example</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#control-rsync-recursive-depth">2.7. control rsync recursive depth</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#skip-scp-if-file-exist-tldr-use-rsync">2.8. skip scp if file exist (tldr - use rsync</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#rsync-symlinks">2.9. rsync symlinks</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#appending-concatenating-variables">2.10. Appending/concatenating variables</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#command-vs-command">2.11. <code class="docutils literal"><span class="pre">command</span></code> vs $(command)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#variable-name-convention">2.12. variable name convention</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#how-to-expand-tilde">2.13. How to expand ~ (tilde)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#create-directory-if-it-doesn-t-exist-06-14-2016-00-17">2.14. Create directory if it doesn&#8217;t exist 06-14-2016 (00:17)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#vs-in-arrays">2.15. [&#64;] vs [*] in arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#id1">2.16. 1&gt;&amp;2</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#if-statements-and-test-conditions">2.17. if statements and test conditions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#argh-can-t-comment-over-line-breaks">2.18. argh...can&#8217;t comment over line breaks....</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-bash-scripts.html#get-directory-of-running-bash-script">2.19. get directory of running bash script</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-qsubber.html">3. qsubber</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-qsubber.html#qsub-helper">3.1. qsub helper</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-qsubber.html#qsub-helper-old-pre-april-2016">3.2. qsub helper (old, pre April 2016</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-qsubber.html#a-3-step-receipe-for-matlab">3.2.1. A 3 step receipe for matlab</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-qsubber.html#memrec-to-evaluate-appropriate-h-vmem-value">3.2.2. <code class="docutils literal"><span class="pre">memrec</span></code> (to evaluate appropriate <code class="docutils literal"><span class="pre">h_vmem</span></code> value</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-qsubber.html#qstat">3.2.3. <code class="docutils literal"><span class="pre">qstat</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-qsubber.html#usr-bin-time-to-see-multithreaded-or-not">3.2.4. <code class="docutils literal"><span class="pre">/usr/bin/time</span></code> to see multithreaded or not</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-python.html">4. Python</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-python.html#random-stack-overflow-questions">4.1. Random Stack-overflow questions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-python.html#when-plt-tight-layout-doesn-t-work-as-expected">4.1.1. When plt.tight_layout doesn&#8217;t work as expected</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-python.html#swap-2-items-in-a-list">4.1.2. Swap 2 items in a list</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-python.html#check-all-items-in-list-or-dict-is-equal">4.1.3. Check all items in list or dict is equal</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-python.html#disk-io">4.2. Disk IO</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-python.html#write-list-items-to-text">4.2.1. Write list items to text</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-python.html#seaborn-and-pandas-plots">4.3. Seaborn and Pandas plots</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-python.html#mpl-and-sns">4.3.1. mpl and sns?</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-python.html#color-palette">4.3.2. Color palette</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-python.html#python-commands-from-shell">4.4. Python commands from shell</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-python.html#matplotlib-styling">4.5. Matplotlib styling</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-python.html#default-color-cycle">4.5.1. Default color cycle</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-python.html#colormap-helper">4.5.2. Colormap helper</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-python.html#installing-modules">4.6. installing modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-python.html#gochtas">4.7. gochtas</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-python.html#careful-with-array-slicing-may-change-array-values">4.7.1. careful with array slicing! may change array values</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-python.html#decorator">4.8. decorator</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-python.html#plotting-short-snippets">4.9. Plotting - short snippets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-python.html#cool-tricks">4.9.1. Cool tricks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-python.html#plotting-snippets">4.9.2. Plotting Snippets</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-python.html#exceptions">4.10. Exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-python.html#clever-tricks">4.11. Clever tricks</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-pyspark.html">5. pyspark</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-pyspark.html#stack-overflows">5.1. Stack overflows</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-pyspark.html#numpy-array-to-spark-dataframe-trickier-than-i-thought">5.1.1. numpy array to spark dataframe...trickier than i thought...</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-pyspark.html#adding-new-columns-to-spark-dataframes">5.1.2. Adding new columns to Spark DataFrames</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-pyspark.html#programming-guide-condensed-summary">5.2. Programming-guide: condensed summary</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-pyspark.html#super-basics">5.2.1. Super basics</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-pyspark.html#shared-variables">5.2.2. Shared variables</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-pyspark.html#broadast-variables">5.2.2.1. Broadast variables</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-pyspark.html#accumulators">5.2.2.2. Accumulators</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-pyspark.html#rdd-operations">5.2.3. RDD operations</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-pyspark.html#rdd-basics">5.2.3.1. RDD-basics</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-pyspark.html#passing-functions-to-spark">5.2.3.2. Passing functions to Spark</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-pyspark.html#rdd-transformations">5.2.3.3. RDD Transformations</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-pyspark.html#rdd-actions">5.2.3.4. RDD Actions</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-pyspark.html#closures">5.2.3.5. closures</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-pyspark.html#working-with-key-value-pairs">5.2.3.6. Working with key-value pairs</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-pyspark.html#random-handy-snippets">5.3. Random handy snippets</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-pyspark.html#compute-average">5.3.1. compute average</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../bct.html">6. Brain Connectivity Toolbox</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../generated/bct.algorithms.html">6.1. bct.algorithms</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../generated/bct.algorithms.html#functions">6.1.1. Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.agreement.html">6.1.1.1. bct.algorithms.agreement</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.agreement_weighted.html">6.1.1.2. bct.algorithms.agreement_weighted</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.assortativity_bin.html">6.1.1.3. bct.algorithms.assortativity_bin</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.assortativity_wei.html">6.1.1.4. bct.algorithms.assortativity_wei</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.betweenness_bin.html">6.1.1.5. bct.algorithms.betweenness_bin</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.betweenness_wei.html">6.1.1.6. bct.algorithms.betweenness_wei</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.binarize.html">6.1.1.7. bct.algorithms.binarize</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.breadth.html">6.1.1.8. bct.algorithms.breadth</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.breadthdist.html">6.1.1.9. bct.algorithms.breadthdist</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.charpath.html">6.1.1.10. bct.algorithms.charpath</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.ci2ls.html">6.1.1.11. bct.algorithms.ci2ls</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.clustering_coef_bd.html">6.1.1.12. bct.algorithms.clustering_coef_bd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.clustering_coef_bu.html">6.1.1.13. bct.algorithms.clustering_coef_bu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.clustering_coef_wd.html">6.1.1.14. bct.algorithms.clustering_coef_wd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.clustering_coef_wu.html">6.1.1.15. bct.algorithms.clustering_coef_wu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.clustering_coef_wu_sign.html">6.1.1.16. bct.algorithms.clustering_coef_wu_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.community_louvain.html">6.1.1.17. bct.algorithms.community_louvain</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.consensus_und.html">6.1.1.18. bct.algorithms.consensus_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.core_periphery_dir.html">6.1.1.19. bct.algorithms.core_periphery_dir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.corr_flat_dir.html">6.1.1.20. bct.algorithms.corr_flat_dir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.corr_flat_und.html">6.1.1.21. bct.algorithms.corr_flat_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.cuberoot.html">6.1.1.22. bct.algorithms.cuberoot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.cycprob.html">6.1.1.23. bct.algorithms.cycprob</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.degrees_dir.html">6.1.1.24. bct.algorithms.degrees_dir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.degrees_und.html">6.1.1.25. bct.algorithms.degrees_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.density_dir.html">6.1.1.26. bct.algorithms.density_dir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.density_und.html">6.1.1.27. bct.algorithms.density_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.dice_pairwise_und.html">6.1.1.28. bct.algorithms.dice_pairwise_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.distance_bin.html">6.1.1.29. bct.algorithms.distance_bin</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.distance_wei.html">6.1.1.30. bct.algorithms.distance_wei</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.diversity_coef_sign.html">6.1.1.31. bct.algorithms.diversity_coef_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.dummyvar.html">6.1.1.32. bct.algorithms.dummyvar</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.edge_betweenness_bin.html">6.1.1.33. bct.algorithms.edge_betweenness_bin</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.edge_betweenness_wei.html">6.1.1.34. bct.algorithms.edge_betweenness_wei</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.edge_nei_overlap_bd.html">6.1.1.35. bct.algorithms.edge_nei_overlap_bd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.edge_nei_overlap_bu.html">6.1.1.36. bct.algorithms.edge_nei_overlap_bu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.efficiency_bin.html">6.1.1.37. bct.algorithms.efficiency_bin</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.efficiency_wei.html">6.1.1.38. bct.algorithms.efficiency_wei</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.eigenvector_centrality_und.html">6.1.1.39. bct.algorithms.eigenvector_centrality_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.erange.html">6.1.1.40. bct.algorithms.erange</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.evaluate_generative_model.html">6.1.1.41. bct.algorithms.evaluate_generative_model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.find_motif34.html">6.1.1.42. bct.algorithms.find_motif34</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.findpaths.html">6.1.1.43. bct.algorithms.findpaths</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.findwalks.html">6.1.1.44. bct.algorithms.findwalks</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.flow_coef_bd.html">6.1.1.45. bct.algorithms.flow_coef_bd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.gateway_coef_sign.html">6.1.1.46. bct.algorithms.gateway_coef_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.generative_model.html">6.1.1.47. bct.algorithms.generative_model</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.get_components.html">6.1.1.48. bct.algorithms.get_components</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.get_components_old.html">6.1.1.49. bct.algorithms.get_components_old</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.gtom.html">6.1.1.50. bct.algorithms.gtom</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.invert.html">6.1.1.51. bct.algorithms.invert</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.jdegree.html">6.1.1.52. bct.algorithms.jdegree</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.kcore_bd.html">6.1.1.53. bct.algorithms.kcore_bd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.kcore_bu.html">6.1.1.54. bct.algorithms.kcore_bu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.kcoreness_centrality_bd.html">6.1.1.55. bct.algorithms.kcoreness_centrality_bd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.kcoreness_centrality_bu.html">6.1.1.56. bct.algorithms.kcoreness_centrality_bu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.latmio_dir.html">6.1.1.57. bct.algorithms.latmio_dir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.latmio_dir_connected.html">6.1.1.58. bct.algorithms.latmio_dir_connected</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.latmio_und.html">6.1.1.59. bct.algorithms.latmio_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.latmio_und_connected.html">6.1.1.60. bct.algorithms.latmio_und_connected</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.link_communities.html">6.1.1.61. bct.algorithms.link_communities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.local_assortativity_wu_sign.html">6.1.1.62. bct.algorithms.local_assortativity_wu_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.ls2ci.html">6.1.1.63. bct.algorithms.ls2ci</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.make_motif34lib.html">6.1.1.64. bct.algorithms.make_motif34lib</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.makeevenCIJ.html">6.1.1.65. bct.algorithms.makeevenCIJ</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.makefractalCIJ.html">6.1.1.66. bct.algorithms.makefractalCIJ</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.makerandCIJ_dir.html">6.1.1.67. bct.algorithms.makerandCIJ_dir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.makerandCIJ_und.html">6.1.1.68. bct.algorithms.makerandCIJ_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.makerandCIJdegreesfixed.html">6.1.1.69. bct.algorithms.makerandCIJdegreesfixed</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.makeringlatticeCIJ.html">6.1.1.70. bct.algorithms.makeringlatticeCIJ</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.maketoeplitzCIJ.html">6.1.1.71. bct.algorithms.maketoeplitzCIJ</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.matching_ind.html">6.1.1.72. bct.algorithms.matching_ind</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.matching_ind_und.html">6.1.1.73. bct.algorithms.matching_ind_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.modularity_dir.html">6.1.1.74. bct.algorithms.modularity_dir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.modularity_finetune_dir.html">6.1.1.75. bct.algorithms.modularity_finetune_dir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.modularity_finetune_und.html">6.1.1.76. bct.algorithms.modularity_finetune_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.modularity_finetune_und_sign.html">6.1.1.77. bct.algorithms.modularity_finetune_und_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.modularity_louvain_dir.html">6.1.1.78. bct.algorithms.modularity_louvain_dir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.modularity_louvain_und.html">6.1.1.79. bct.algorithms.modularity_louvain_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.modularity_louvain_und_sign.html">6.1.1.80. bct.algorithms.modularity_louvain_und_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.modularity_probtune_und_sign.html">6.1.1.81. bct.algorithms.modularity_probtune_und_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.modularity_und.html">6.1.1.82. bct.algorithms.modularity_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.modularity_und_sign.html">6.1.1.83. bct.algorithms.modularity_und_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.module_degree_zscore.html">6.1.1.84. bct.algorithms.module_degree_zscore</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.motif3funct_bin.html">6.1.1.85. bct.algorithms.motif3funct_bin</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.motif3funct_wei.html">6.1.1.86. bct.algorithms.motif3funct_wei</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.motif3struct_bin.html">6.1.1.87. bct.algorithms.motif3struct_bin</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.motif3struct_wei.html">6.1.1.88. bct.algorithms.motif3struct_wei</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.motif4funct_bin.html">6.1.1.89. bct.algorithms.motif4funct_bin</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.motif4funct_wei.html">6.1.1.90. bct.algorithms.motif4funct_wei</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.motif4struct_bin.html">6.1.1.91. bct.algorithms.motif4struct_bin</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.motif4struct_wei.html">6.1.1.92. bct.algorithms.motif4struct_wei</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.normalize.html">6.1.1.93. bct.algorithms.normalize</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.null_model_dir_sign.html">6.1.1.94. bct.algorithms.null_model_dir_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.null_model_und_sign.html">6.1.1.95. bct.algorithms.null_model_und_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.number_of_components.html">6.1.1.96. bct.algorithms.number_of_components</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.pagerank_centrality.html">6.1.1.97. bct.algorithms.pagerank_centrality</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.participation_coef.html">6.1.1.98. bct.algorithms.participation_coef</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.participation_coef_sign.html">6.1.1.99. bct.algorithms.participation_coef_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.partition_distance.html">6.1.1.100. bct.algorithms.partition_distance</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.pick_four_unique_nodes_quickly.html">6.1.1.101. bct.algorithms.pick_four_unique_nodes_quickly</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.randmio_dir.html">6.1.1.102. bct.algorithms.randmio_dir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.randmio_dir_connected.html">6.1.1.103. bct.algorithms.randmio_dir_connected</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.randmio_dir_signed.html">6.1.1.104. bct.algorithms.randmio_dir_signed</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.randmio_und.html">6.1.1.105. bct.algorithms.randmio_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.randmio_und_connected.html">6.1.1.106. bct.algorithms.randmio_und_connected</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.randmio_und_signed.html">6.1.1.107. bct.algorithms.randmio_und_signed</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.randomize_graph_partial_und.html">6.1.1.108. bct.algorithms.randomize_graph_partial_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.randomizer_bin_und.html">6.1.1.109. bct.algorithms.randomizer_bin_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.reachdist.html">6.1.1.110. bct.algorithms.reachdist</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.rentian_scaling.html">6.1.1.111. bct.algorithms.rentian_scaling</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.rich_club_bd.html">6.1.1.112. bct.algorithms.rich_club_bd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.rich_club_bu.html">6.1.1.113. bct.algorithms.rich_club_bu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.rich_club_wd.html">6.1.1.114. bct.algorithms.rich_club_wd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.rich_club_wu.html">6.1.1.115. bct.algorithms.rich_club_wu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.score_wu.html">6.1.1.116. bct.algorithms.score_wu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.strengths_dir.html">6.1.1.117. bct.algorithms.strengths_dir</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.strengths_und.html">6.1.1.118. bct.algorithms.strengths_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.strengths_und_sign.html">6.1.1.119. bct.algorithms.strengths_und_sign</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.subgraph_centrality.html">6.1.1.120. bct.algorithms.subgraph_centrality</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.transitivity_bd.html">6.1.1.121. bct.algorithms.transitivity_bd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.transitivity_bu.html">6.1.1.122. bct.algorithms.transitivity_bu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.transitivity_wd.html">6.1.1.123. bct.algorithms.transitivity_wd</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.transitivity_wu.html">6.1.1.124. bct.algorithms.transitivity_wu</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/bct.algorithms.html#exceptions">6.1.2. Exceptions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.algorithms.BCTParamError.html">6.1.2.1. bct.algorithms.BCTParamError</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/bct.utils.html">6.2. bct.utils</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../generated/bct.utils.html#functions">6.2.1. Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.adjacency_plot_und.html">6.2.1.1. bct.utils.adjacency_plot_und</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.align_matrices.html">6.2.1.2. bct.utils.align_matrices</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.autofix.html">6.2.1.3. bct.utils.autofix</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.backbone_wu.html">6.2.1.4. bct.utils.backbone_wu</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.binarize.html">6.2.1.5. bct.utils.binarize</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.cuberoot.html">6.2.1.6. bct.utils.cuberoot</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.dummyvar.html">6.2.1.7. bct.utils.dummyvar</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.grid_communities.html">6.2.1.8. bct.utils.grid_communities</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.invert.html">6.2.1.9. bct.utils.invert</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.normalize.html">6.2.1.10. bct.utils.normalize</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.pick_four_unique_nodes_quickly.html">6.2.1.11. bct.utils.pick_four_unique_nodes_quickly</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.reorderMAT.html">6.2.1.12. bct.utils.reorderMAT</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.reorder_matrix.html">6.2.1.13. bct.utils.reorder_matrix</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.reorder_mod.html">6.2.1.14. bct.utils.reorder_mod</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.teachers_round.html">6.2.1.15. bct.utils.teachers_round</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.threshold_absolute.html">6.2.1.16. bct.utils.threshold_absolute</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.threshold_proportional.html">6.2.1.17. bct.utils.threshold_proportional</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.weight_conversion.html">6.2.1.18. bct.utils.weight_conversion</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.writetoPAJ.html">6.2.1.19. bct.utils.writetoPAJ</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/bct.utils.html#exceptions">6.2.2. Exceptions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.utils.BCTParamError.html">6.2.2.1. bct.utils.BCTParamError</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../generated/bct.nbs.html">6.3. bct.nbs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../generated/bct.nbs.html#functions">6.3.1. Functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.nbs.get_components.html">6.3.1.1. bct.nbs.get_components</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.nbs.nbs_bct.html">6.3.1.2. bct.nbs.nbs_bct</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../generated/bct.nbs.html#exceptions">6.3.2. Exceptions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../generated/bct.nbs.BCTParamError.html">6.3.2.1. bct.nbs.BCTParamError</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-sphinx.html">7. sphinx</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sphinx.html#lookups">7.1. Lookups</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#references-for-rst-in-general-non-sphinx">7.1.1. References for rst in general (non-sphinx)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sphinx.html#autodoc-related">7.2. Autodoc related</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#main-directives">7.2.1. Main directives</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#directive-options">7.2.2. directive options</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#my-usage-example">7.2.2.1. My usage example</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#autosummary-my-notes-highly-incomplete-better-to-look-at-the-doc-page">7.2.3. autosummary (my notes highly incomplete...better to look at the doc page)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#autosummary-directive">7.2.3.1. autosummary directive</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#options">7.2.3.2. options</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#pandas-example">7.2.3.3. pandas example</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sphinx.html#conf-py-related">7.3. conf.py related</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#example-conf-py">7.3.1. Example conf.py</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#extensions">7.3.2. extensions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#ones-i-care-about-including-3rd-party-keep-adding-to-the-list-as-i-find-new-ones">7.3.2.1. Ones i care about (including 3rd party...keep adding to the list as i find new ones)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#examples">7.3.2.2. Examples</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#sphinx-built-in">7.3.2.3. Sphinx built-in</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#rd-party-extensions">7.3.2.4. 3rd party extensions</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#rtd-theme-one-of-my-favorite-html-theme">7.3.3. rtd theme (one of my favorite html-theme)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sphinx.html#functions-i-use-frequently-non-autodoc-ones">7.4. Functions I use frequently (non-autodoc ones)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#toctree">7.4.1. toctree</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#code">7.4.2. Code</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#literal-includes-include-code-from-external-file">7.4.2.1. Literal includes (include code from external file)</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#python-directives-and-roles">7.4.3. Python directives and roles</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#directives">7.4.3.1. Directives</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#roles">7.4.3.2. roles</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#info-field">7.4.3.3. Info field</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#inline-markups-mostly-for-cross-referencing-via-ref">7.4.4. inline markups (mostly for cross-referencing via :ref:)</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#ref">7.4.4.1. ref</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sphinx.html#example-usage">7.4.4.2. Example usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#paragraph-level-directives">7.4.5. Paragraph-level directives</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sphinx.html#restructured-text-primer">7.5. restructured text primer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#heading-level-convention">7.5.1. Heading-level convention</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#line-blocks">7.5.2. Line blocks</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#citations">7.5.3. Citations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#links">7.5.4. links</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#id1">7.5.5. citations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#substitutions-stuffs">7.5.6. substitutions |stuffs|</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#comments">7.5.7. comments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sphinx.html#master-document-index-rst">7.6. master document (index.rst)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sphinx.html#publishing-on-github">7.7. Publishing on github</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sphinx.html#sphinx-quickstart">7.8. sphinx quickstart</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#queries">7.8.1. queries</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#doc">7.8.2. doc</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sphinx.html#google-style-vs-numpy-style-docstring">7.9. Google-style vs numpy-style docstring</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#google-style-like-theano">7.9.1. Google style (like theano)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sphinx.html#numpy-style-my-preference">7.9.2. NumPy style (my preference)</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-R.html">8. R</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-R.html#snippets-in-rstudio">8.1. Snippets in RStudio</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-R.html#current-content-in-r-snippets">8.1.1. Current content in <code class="docutils literal"><span class="pre">r.snippets</span></code></a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-R.html#todo-break-these-down-to-smaller-pieces">8.2. TODO: break these down to smaller pieces</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-awk-oneliners.html">9. awk-oneliners</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-awk-oneliners.html#file-spacing">9.1. File spacing</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-awk-oneliners.html#numbering-and-calculations">9.2. NUMBERING AND CALCULATIONS:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-awk-oneliners.html#string-creation">9.3. STRING CREATION:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-awk-oneliners.html#array-creation">9.4. ARRAY CREATION:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-awk-oneliners.html#text-conversion-and-substitution">9.5. TEXT CONVERSION AND SUBSTITUTION:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-awk-oneliners.html#selective-printing-of-certain-lines">9.6. SELECTIVE PRINTING OF CERTAIN LINES:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-awk-oneliners.html#selective-deletion-of-certain-lines">9.7. SELECTIVE DELETION OF CERTAIN LINES:</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-perl-oneliners.html">10. perl one-liners</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-perl-oneliners.html#file-spacing">10.1. FILE SPACING</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-perl-oneliners.html#line-numbering">10.2. LINE NUMBERING</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-perl-oneliners.html#calculations">10.3. CALCULATIONS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-perl-oneliners.html#string-creation-and-array-creation">10.4. STRING CREATION AND ARRAY CREATION</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-perl-oneliners.html#text-conversion-and-substitution">10.5. TEXT CONVERSION AND SUBSTITUTION</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-perl-oneliners.html#selective-printing-and-deleting-of-certain-lines">10.6. SELECTIVE PRINTING AND DELETING OF CERTAIN LINES</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-perl-oneliners.html#handy-regular-expressions">10.7. HANDY REGULAR EXPRESSIONS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-perl-oneliners.html#perl-tricks">10.8. PERL TRICKS</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-perl-oneliners.html#perl-one-liners-explained-e-book">10.9. PERL ONE-LINERS EXPLAINED E-BOOK</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-py-jupyter-notebook.html">11. python-jupyter-notebook</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-py-jupyter-notebook.html#ipython-notebook-defaults">11.1. Ipython notebook defaults</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-py-jupyter-notebook.html#frequently-used-config">11.1.1. Frequently used config</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-py-jupyter-notebook.html#widgets">11.2. widgets</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-py-jupyter-notebook.html#current-config">11.3. Current config</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-regexp.html">12. regular expressions</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-regexp.html#regular-expression-references">12.1. Regular expression references</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-regexp.html#sublimetext">12.2. Sublimetext</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-regexp.html#regular-expression-regexp-for-python">12.3. Regular expression (regexp) for python</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-regexp.html#basic-functions-modules">12.3.1. Basic functions/modules</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-regexp.html#splitting-strings">12.3.2. Splitting strings</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-regexp.html#search-and-replace-with-sub">12.3.3. Search and replace with sub</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-regexp.html#compilation-flags">12.3.4. Compilation flags</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-regexp.html#greedy-vs-nongreedy">12.3.5. Greedy vs nongreedy</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-regexp.html#improve-readibility-with-re-verbose-flag">12.3.6. Improve readibility with re.Verbose flag</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-regexp.html#named-groups">12.3.7. Named groups</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-regexp.html#lookahed-assertions">12.3.8. Lookahed assertions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-regexp.html#bunch-of-examples">12.3.9. Bunch of examples</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-rst.html">13. rst</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-rst.html#lookups">13.1. Lookups</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#tutorials">13.1.1. Tutorials</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#header-convention-me">13.1.2. header convention (me)</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-rst.html#sphinx-based">13.2. Sphinx-based</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#autodoc">13.2.1. autodoc</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-rst.html#recursive-docstringing-objects">13.2.1.1. recursive docstringing objects</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#links-url">13.2.2. Links (url)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#markup-showing-code-inlines">13.2.3. markup, showing code, inlines</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#inline-bunch-of-roles">13.2.4. inline (bunch of roles)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#domain">13.2.5. domain</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#python-domain">13.2.6. python domain</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#misc-examples">13.2.7. misc examples</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#link-documents">13.2.8. Link documents</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#conf-py-setup">13.2.9. conf.py setup</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-rst.html#conf-py-html-output-options">13.2.9.1. conf.py - html output options</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#extensions">13.2.10. Extensions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#examples-conf-py-and-github">13.2.11. Examples conf.py and github</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-rst.html#great-cheatsheet-standard">13.2.11.1. Great cheatsheet (standard)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-rst.html#sphinx-doc-sphinx13">13.2.11.2. Sphinx doc (sphinx13)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-rst.html#nimfa-alabaster">13.2.11.3. nimfa (alabaster)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-rst.html#pandas">13.2.11.4. pandas</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-rst.html#scipy-lecture-notes">13.2.11.5. scipy lecture notes</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-rst.html#scikit-learn">13.2.11.6. scikit-learn</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#themes">13.2.12. themes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#toctree-options">13.2.13. toctree options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#references-and-citations">13.2.14. References and citations</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#matplotlib-ipython-directive-options">13.2.15. matplotlib, ipython directive options</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-rst.html#useful-directives">13.3. Useful directives</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#replace">13.3.1. replace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#date">13.3.2. date</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#raw-directive">13.3.3. raw directive</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#class-directive">13.3.4. class directive</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#role-directive">13.3.5. role directive</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-rst.html#default-interpreted-text-role">13.3.5.1. default interpreted text role</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#unicodes">13.3.6. Unicodes</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#image">13.3.7. image</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#csv-table">13.3.8. csv-table</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#header-and-footer">13.3.9. header and footer</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#math-won-t-render-on-github-works-on-bitbucket">13.3.10. math (won&#8217;t render on github (works on bitbucket)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#id9">13.3.11. replace</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#id10">13.3.12. date</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#lists">13.3.13. Lists</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#comments">13.3.14. Comments</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-rst.html#roles-in-rst">13.4. roles in RST</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#list-of-equivalent-roles-ultra-incomplete">13.4.1. List of equivalent <code class="docutils literal"><span class="pre">roles</span></code> (ultra-incomplete)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst.html#some-interesting-looking-roles">13.4.2. Some interesting looking <code class="docutils literal"><span class="pre">roles</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-rst-old.html">14. rst cheatsheet (old)</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-rst-old.html#directives-i-found-useful-or-runs-on-github">14.1. DIRECTIVES I FOUND USEFUL OR RUNS ON GITHUB</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#image">14.1.1. .. image::</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#code-use-with-number-lines-option">14.1.2. .. code:: (use with <code class="docutils literal"><span class="pre">:number-lines:</span></code> option)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#table">14.1.3. .. table::</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#csv-table">14.1.4. .. csv-table::</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#contents">14.1.5. .. contents::</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#sectnum-works-but-warning-seem-to-screw-up-the-toc-link">14.1.6. .. sectnum:: ...works....but <strong>WARNING!</strong> - seem to screw up the TOC link</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#header-and-footer">14.1.7. .. header:: (and .. footer::)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#sadly-math-doesn-t-render-on-github-works-on-bitbucket">14.1.8. Sadly <code class="docutils literal"><span class="pre">..</span> <span class="pre">math::</span></code> doesn&#8217;t render on github (works on bitbucket)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#replace">14.1.9. .. replace::</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#unicode">14.1.10. .. unicode::</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#date">14.1.11. ..date::</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-rst-old.html#list-of-gotcha-s-to-watch-out-for-at-least-the-ones-i-suffered-from">14.2. List of <strong>GOTCHA&#8217;s</strong> to watch out for (at least the ones I suffered from...)</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#gotcha-s-with-nested-list-items">14.2.1. Gotcha&#8217;s with nested list items</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#id1">14.2.2. Sadly <code class="docutils literal"><span class="pre">..</span> <span class="pre">math::</span></code> doesn&#8217;t render on github (works on bitbucket)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#gotcha-s-with-contents">14.2.3. GOTCHA&#8217;s with <code class="docutils literal"><span class="pre">..</span> <span class="pre">contents::</span></code></a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#h1-h2-problems">14.2.4. <code class="docutils literal"><span class="pre">h1</span></code> <code class="docutils literal"><span class="pre">h2</span></code> ... problems</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#including-styles-on-header-names-will-break-the-toc-link-on-github-unconfirmed">14.2.5. Including styles on HEADER-NAMES will break the TOC link on github (unconfirmed)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#directives-that-just-doesnt-work-on-github-or-sublime-text">14.2.6. Directives that just doesnt work on github or Sublime Text</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#some-special-characters-that-may-be-a-head-ache-to-print">14.2.7. Some special characters that may be a head-ache to print</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-rst-old.html#roles-in-rst">14.3. <code class="docutils literal"><span class="pre">roles</span></code> in RST</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#list-of-equivalent-roles-ultra-incomplete">14.3.1. List of equivalent <code class="docutils literal"><span class="pre">roles</span></code> (ultra-incomplete)</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-rst-old.html#some-interesting-looking-roles">14.3.2. Some interesting looking <code class="docutils literal"><span class="pre">roles</span></code></a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-sed-oneliners.html">15. sed oneliners</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sed-oneliners.html#typical-use">15.1. Typical use</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sed-oneliners.html#file-spacing">15.2. FILE SPACING:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sed-oneliners.html#numbering">15.3. NUMBERING:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sed-oneliners.html#text-conversion-and-substitution">15.4. TEXT CONVERSION AND SUBSTITUTION:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sed-oneliners.html#selective-printing-of-certain-lines">15.5. SELECTIVE PRINTING OF CERTAIN LINES:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sed-oneliners.html#selective-deletion-of-certain-lines">15.6. SELECTIVE DELETION OF CERTAIN LINES:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sed-oneliners.html#special-applications">15.7. SPECIAL APPLICATIONS:</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sed-oneliners.html#misc">15.8. Misc</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-sed.html">16. sed</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sed.html#ultra-basics">16.1. ultra-basics</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sed.html#more-basics">16.2. More Basics</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sed.html#the-e-f-options">16.2.1. the -e, -f options</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sed.html#deletion-commands">16.2.2. deletion commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sed.html#substitution-flags">16.2.3. substitution flags</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-sql.html">17. sql</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sql.html#style-guidelines-conventions">17.1. Style guidelines, conventions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sql.html#basic-commands-keywords">17.2. Basic commands/keywords</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sql.html#sql-zoo">17.3. sql-zoo</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sql.html#select-basics">17.3.1. SELECT basics</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sql.html#sorting-records-with-order-by">17.3.1.1. sorting records with ORDER BY</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sql.html#wildcards">17.3.1.2. wildcards</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sql.html#case-statement">17.3.1.3. CASE statement</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../cs-sql.html#math-functions">17.3.2. math functions</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sql.html#aggregate-functions-sum-count-avg-etc">17.3.2.1. Aggregate functions (SUM, COUNT, AVG, etc)</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../cs-sql.html#group-by-and-having">17.3.2.2. GROUP BY and HAVING</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-sql.html#different-rdbms">17.4. different RDBMS</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../cs-scala.html">18. Scala</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../cs-scala.html#random-overflow-threads">18.1. Random overflow threads</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-scala.html#linear-algebra-in-scala">18.2. Linear algebra in scala?</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../cs-scala.html#scala-lab">18.3. scala-lab?</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../awk-tutorial/index.html">19. awk-tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../awk-tutorial/awk-basic-structure.html">19.1. Basic structure</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../awk-tutorial/awk-essential-syntax.html">19.2. The Essential Syntax of AWK</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-essential-syntax.html#unary-arithmetic-operators">19.2.1. Unary arithmetic operators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-essential-syntax.html#the-autoincrement-and-autodecrement-operators">19.2.2. The Autoincrement and Autodecrement Operators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-essential-syntax.html#assignment-operators">19.2.3. Assignment Operators</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-essential-syntax.html#conditional-expressions">19.2.4. Conditional expressions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-essential-syntax.html#regular-expressions">19.2.5. Regular Expressions</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-essential-syntax.html#and-or-not">19.2.6. And/Or/Not</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../awk-tutorial/awk-summary-commands.html">19.3. Summary of AWK Commands</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../awk-tutorial/awk-builtin-vars.html">19.4. AWK Built-in Variables</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-builtin-vars.html#fs-the-input-field-separator-variable">19.4.1. FS - The Input Field Separator Variable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-builtin-vars.html#ofs-the-output-field-separator-variable">19.4.2. OFS - The Output Field Separator Variable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-builtin-vars.html#nf-the-number-of-fields-variable">19.4.3. NF - The Number of Fields Variable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-builtin-vars.html#nr-the-number-of-records-variable">19.4.4. NR - The Number of Records Variable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-builtin-vars.html#rs-the-record-separator-variable">19.4.5. RS - The Record Separator Variable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-builtin-vars.html#ors-the-output-record-separator-variable">19.4.6. ORS - The Output Record Separator Variable</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../awk-tutorial/awk-builtin-vars.html#filename-the-current-filename-variable">19.4.7. FILENAME - The Current Filename Variable</a></li>
</ul>
</li>
</ul>
</li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Snippets</a>
        
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          













<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>sphinx.environment</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
        
      </li>
    
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for sphinx.environment</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    sphinx.environment</span>
<span class="sd">    ~~~~~~~~~~~~~~~~~~</span>

<span class="sd">    Global creation environment.</span>

<span class="sd">    :copyright: Copyright 2007-2016 by the Sphinx team, see AUTHORS.</span>
<span class="sd">    :license: BSD, see LICENSE for details.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">bisect</span>
<span class="kn">import</span> <span class="nn">codecs</span>
<span class="kn">import</span> <span class="nn">string</span>
<span class="kn">import</span> <span class="nn">fnmatch</span>
<span class="kn">import</span> <span class="nn">unicodedata</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">path</span>
<span class="kn">from</span> <span class="nn">glob</span> <span class="k">import</span> <span class="n">glob</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="k">import</span> <span class="n">groupby</span>

<span class="kn">from</span> <span class="nn">six</span> <span class="k">import</span> <span class="n">iteritems</span><span class="p">,</span> <span class="n">itervalues</span><span class="p">,</span> <span class="n">text_type</span><span class="p">,</span> <span class="n">class_types</span><span class="p">,</span> <span class="nb">next</span>
<span class="kn">from</span> <span class="nn">six.moves</span> <span class="k">import</span> <span class="n">cPickle</span> <span class="k">as</span> <span class="n">pickle</span>
<span class="kn">from</span> <span class="nn">docutils</span> <span class="k">import</span> <span class="n">nodes</span>
<span class="kn">from</span> <span class="nn">docutils.io</span> <span class="k">import</span> <span class="n">NullOutput</span>
<span class="kn">from</span> <span class="nn">docutils.core</span> <span class="k">import</span> <span class="n">Publisher</span>
<span class="kn">from</span> <span class="nn">docutils.utils</span> <span class="k">import</span> <span class="n">Reporter</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">,</span> <span class="n">get_source_line</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst</span> <span class="k">import</span> <span class="n">roles</span><span class="p">,</span> <span class="n">directives</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst.languages</span> <span class="k">import</span> <span class="n">en</span> <span class="k">as</span> <span class="n">english</span>
<span class="kn">from</span> <span class="nn">docutils.parsers.rst.directives.html</span> <span class="k">import</span> <span class="n">MetaBody</span>
<span class="kn">from</span> <span class="nn">docutils.frontend</span> <span class="k">import</span> <span class="n">OptionParser</span>

<span class="kn">from</span> <span class="nn">sphinx</span> <span class="k">import</span> <span class="n">addnodes</span>
<span class="kn">from</span> <span class="nn">sphinx.io</span> <span class="k">import</span> <span class="n">SphinxStandaloneReader</span><span class="p">,</span> <span class="n">SphinxDummyWriter</span><span class="p">,</span> <span class="n">SphinxFileInput</span>
<span class="kn">from</span> <span class="nn">sphinx.util</span> <span class="k">import</span> <span class="n">url_re</span><span class="p">,</span> <span class="n">get_matching_docs</span><span class="p">,</span> <span class="n">docname_join</span><span class="p">,</span> <span class="n">split_into</span><span class="p">,</span> \
    <span class="n">FilenameUniqDict</span><span class="p">,</span> <span class="n">split_index_msg</span>
<span class="kn">from</span> <span class="nn">sphinx.util.nodes</span> <span class="k">import</span> <span class="n">clean_astext</span><span class="p">,</span> <span class="n">make_refnode</span><span class="p">,</span> <span class="n">WarningStream</span><span class="p">,</span> <span class="n">is_translatable</span>
<span class="kn">from</span> <span class="nn">sphinx.util.osutil</span> <span class="k">import</span> <span class="n">SEP</span><span class="p">,</span> <span class="n">getcwd</span><span class="p">,</span> <span class="n">fs_encoding</span><span class="p">,</span> <span class="n">ensuredir</span>
<span class="kn">from</span> <span class="nn">sphinx.util.images</span> <span class="k">import</span> <span class="n">guess_mimetype</span>
<span class="kn">from</span> <span class="nn">sphinx.util.i18n</span> <span class="k">import</span> <span class="n">find_catalog_files</span><span class="p">,</span> <span class="n">get_image_filename_for_language</span><span class="p">,</span> \
    <span class="n">search_image_for_language</span>
<span class="kn">from</span> <span class="nn">sphinx.util.console</span> <span class="k">import</span> <span class="n">bold</span><span class="p">,</span> <span class="n">purple</span>
<span class="kn">from</span> <span class="nn">sphinx.util.matching</span> <span class="k">import</span> <span class="n">compile_matchers</span>
<span class="kn">from</span> <span class="nn">sphinx.util.parallel</span> <span class="k">import</span> <span class="n">ParallelTasks</span><span class="p">,</span> <span class="n">parallel_available</span><span class="p">,</span> <span class="n">make_chunks</span>
<span class="kn">from</span> <span class="nn">sphinx.util.websupport</span> <span class="k">import</span> <span class="n">is_commentable</span>
<span class="kn">from</span> <span class="nn">sphinx.errors</span> <span class="k">import</span> <span class="n">SphinxError</span><span class="p">,</span> <span class="n">ExtensionError</span>
<span class="kn">from</span> <span class="nn">sphinx.locale</span> <span class="k">import</span> <span class="n">_</span>
<span class="kn">from</span> <span class="nn">sphinx.versioning</span> <span class="k">import</span> <span class="n">add_uids</span><span class="p">,</span> <span class="n">merge_doctrees</span>
<span class="kn">from</span> <span class="nn">sphinx.transforms</span> <span class="k">import</span> <span class="n">SphinxContentsFilter</span>

<span class="n">orig_role_function</span> <span class="o">=</span> <span class="n">roles</span><span class="o">.</span><span class="n">role</span>
<span class="n">orig_directive_function</span> <span class="o">=</span> <span class="n">directives</span><span class="o">.</span><span class="n">directive</span>


<span class="k">class</span> <span class="nc">ElementLookupError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="n">default_settings</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;embed_stylesheet&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;cloak_email_addresses&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;pep_base_url&#39;</span><span class="p">:</span> <span class="s1">&#39;https://www.python.org/dev/peps/&#39;</span><span class="p">,</span>
    <span class="s1">&#39;rfc_base_url&#39;</span><span class="p">:</span> <span class="s1">&#39;https://tools.ietf.org/html/&#39;</span><span class="p">,</span>
    <span class="s1">&#39;input_encoding&#39;</span><span class="p">:</span> <span class="s1">&#39;utf-8-sig&#39;</span><span class="p">,</span>
    <span class="s1">&#39;doctitle_xform&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;sectsubtitle_xform&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;halt_level&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
    <span class="s1">&#39;file_insertion_enabled&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1"># This is increased every time an environment attribute is added</span>
<span class="c1"># or changed to properly invalidate pickle files.</span>
<span class="c1">#</span>
<span class="c1"># NOTE: increase base version by 2 to have distinct numbers for Py2 and 3</span>
<span class="n">ENV_VERSION</span> <span class="o">=</span> <span class="mi">49</span> <span class="o">+</span> <span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>


<span class="n">dummy_reporter</span> <span class="o">=</span> <span class="n">Reporter</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>

<span class="n">versioning_conditions</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;none&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">is_translatable</span><span class="p">,</span>
    <span class="s1">&#39;commentable&#39;</span><span class="p">:</span> <span class="n">is_commentable</span><span class="p">,</span>
<span class="p">}</span>


<span class="k">class</span> <span class="nc">NoUri</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised by get_relative_uri if there is no URI available.&quot;&quot;&quot;</span>
    <span class="k">pass</span>


<div class="viewcode-block" id="BuildEnvironment"><a class="viewcode-back" href="../../DIRNAME/sphinx.environment.BuildEnvironment.html#sphinx.environment.BuildEnvironment">[docs]</a><span class="k">class</span> <span class="nc">BuildEnvironment</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The environment in which the ReST files are translated.</span>
<span class="sd">    Stores an inventory of cross-file targets and provides doctree</span>
<span class="sd">    transformations to resolve links to them.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># --------- ENVIRONMENT PERSISTENCE ----------------------------------------</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">frompickle</span><span class="p">(</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="n">picklefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">env</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">picklefile</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">picklefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">version</span> <span class="o">!=</span> <span class="n">ENV_VERSION</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;build environment version not current&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">env</span><span class="o">.</span><span class="n">srcdir</span> <span class="o">!=</span> <span class="n">srcdir</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;source directory has changed&#39;</span><span class="p">)</span>
        <span class="n">env</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">values</span>
        <span class="k">return</span> <span class="n">env</span>

    <span class="k">def</span> <span class="nf">topickle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="c1"># remove unpicklable attributes</span>
        <span class="n">warnfunc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_warnfunc</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_warnfunc</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">values</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">values</span>
        <span class="n">domains</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span>
        <span class="n">picklefile</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="c1"># remove potentially pickling-problematic values from config</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="nb">vars</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">)</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">key</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">ModuleType</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">types</span><span class="o">.</span><span class="n">FunctionType</span><span class="p">)</span> <span class="ow">or</span> \
               <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">class_types</span><span class="p">):</span>
                <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">picklefile</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">picklefile</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># reset attributes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domains</span> <span class="o">=</span> <span class="n">domains</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">values</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">set_warnfunc</span><span class="p">(</span><span class="n">warnfunc</span><span class="p">)</span>

    <span class="c1"># --------- ENVIRONMENT INITIALIZATION -------------------------------------</span>

<div class="viewcode-block" id="BuildEnvironment.__init__"><a class="viewcode-back" href="../../DIRNAME/sphinx.environment.BuildEnvironment.html#sphinx.environment.BuildEnvironment.__init__">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">srcdir</span><span class="p">,</span> <span class="n">doctreedir</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doctreedir</span> <span class="o">=</span> <span class="n">doctreedir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span> <span class="o">=</span> <span class="n">srcdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="c1"># the method of doctree versioning; see set_versioning_method</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">versioning_condition</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">versioning_compare</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># the application object; only set while update() runs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># all the registered domains, set by the application</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domains</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># the docutils settings for building</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span> <span class="o">=</span> <span class="n">default_settings</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;env&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>

        <span class="c1"># the function to write warning messages with</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warnfunc</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># this is to invalidate old pickles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ENV_VERSION</span>

        <span class="c1"># All &quot;docnames&quot; here are /-separated and relative and exclude</span>
        <span class="c1"># the source suffix.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">found_docs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>     <span class="c1"># contains all existing docnames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_docs</span> <span class="o">=</span> <span class="p">{}</span>          <span class="c1"># docname -&gt; mtime at the time of reading</span>
                                    <span class="c1"># contains all read docnames</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span> <span class="o">=</span> <span class="p">{}</span>      <span class="c1"># docname -&gt; set of dependent file</span>
                                    <span class="c1"># names, relative to documentation root</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">included</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>       <span class="c1"># docnames included from other documents</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reread_always</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># docnames to re-read unconditionally on</span>
                                    <span class="c1"># next build</span>

        <span class="c1"># File metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="p">{}</span>          <span class="c1"># docname -&gt; dict of metadata items</span>

        <span class="c1"># TOC inventory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">titles</span> <span class="o">=</span> <span class="p">{}</span>            <span class="c1"># docname -&gt; title node</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">longtitles</span> <span class="o">=</span> <span class="p">{}</span>        <span class="c1"># docname -&gt; title node; only different if</span>
                                    <span class="c1"># set differently with title directive</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">tocs</span> <span class="o">=</span> <span class="p">{}</span>              <span class="c1"># docname -&gt; table of contents nodetree</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc_num_entries</span> <span class="o">=</span> <span class="p">{}</span>   <span class="c1"># docname -&gt; number of real entries</span>
        <span class="c1"># used to determine when to show the TOC</span>
        <span class="c1"># in a sidebar (don&#39;t show if it&#39;s only one item)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc_secnumbers</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># docname -&gt; dict of sectionid -&gt; number</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc_fignumbers</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># docname -&gt; dict of figtype -&gt;</span>
                                    <span class="c1"># dict of figureid -&gt; number</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">toctree_includes</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># docname -&gt; list of toctree includefiles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files_to_rebuild</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># docname -&gt; set of files</span>
                                    <span class="c1"># (containing its TOCs) to rebuild too</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">glob_toctrees</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># docnames that have :glob: toctrees</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numbered_toctrees</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>  <span class="c1"># docnames that have :numbered: toctrees</span>

        <span class="c1"># domain-specific inventories, here to be pickled</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">domaindata</span> <span class="o">=</span> <span class="p">{}</span>        <span class="c1"># domainname -&gt; domain-specific dict</span>

        <span class="c1"># Other inventories</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">citations</span> <span class="o">=</span> <span class="p">{}</span>         <span class="c1"># citation name -&gt; docname, labelid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexentries</span> <span class="o">=</span> <span class="p">{}</span>      <span class="c1"># docname -&gt; list of</span>
                                    <span class="c1"># (type, string, target, aliasname)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">versionchanges</span> <span class="o">=</span> <span class="p">{}</span>    <span class="c1"># version -&gt; list of (type, docname,</span>
                                    <span class="c1"># lineno, module, descname, content)</span>

        <span class="c1"># these map absolute path -&gt; (docnames, unique filename)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="n">FilenameUniqDict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dlfiles</span> <span class="o">=</span> <span class="n">FilenameUniqDict</span><span class="p">()</span>

        <span class="c1"># temporary data storage while reading a document</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_data</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># context for cross-references (e.g. current module or class)</span>
        <span class="c1"># this is similar to temp_data, but will for example be copied to</span>
        <span class="c1"># attributes of &quot;any&quot; cross references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_context</span> <span class="o">=</span> <span class="p">{}</span></div>

    <span class="k">def</span> <span class="nf">set_warnfunc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warnfunc</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;warning_stream&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">WarningStream</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">set_versioning_method</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">method</span><span class="p">,</span> <span class="n">compare</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This sets the doctree versioning method for this environment.</span>

<span class="sd">        Versioning methods are a builder property; only builders with the same</span>
<span class="sd">        versioning method can share the same doctree directory.  Therefore, we</span>
<span class="sd">        raise an exception if the user tries to use an environment with an</span>
<span class="sd">        incompatible versioning method.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">method</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">versioning_conditions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;invalid versioning method: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">method</span><span class="p">)</span>
        <span class="n">condition</span> <span class="o">=</span> <span class="n">versioning_conditions</span><span class="p">[</span><span class="n">method</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">versioning_condition</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="n">condition</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SphinxError</span><span class="p">(</span><span class="s1">&#39;This environment is incompatible with the &#39;</span>
                              <span class="s1">&#39;selected builder, please choose another &#39;</span>
                              <span class="s1">&#39;doctree directory.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">versioning_condition</span> <span class="o">=</span> <span class="n">condition</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">versioning_compare</span> <span class="o">=</span> <span class="n">compare</span>

    <span class="k">def</span> <span class="nf">warn</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">lineno</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Emit a warning.</span>

<span class="sd">        This differs from using ``app.warn()`` in that the warning may not</span>
<span class="sd">        be emitted instantly, but collected for emitting all warnings after</span>
<span class="sd">        the update of the environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># strange argument order is due to backwards compatibility</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warnfunc</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">lineno</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">warn_node</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Like :meth:`warn`, but with source information taken from *node*.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_warnfunc</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">get_source_line</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">clear_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Remove all traces of a source file in the inventory.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">docname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_docs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_docs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reread_always</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">longtitles</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tocs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toc_secnumbers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toc_fignumbers</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toc_num_entries</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toctree_includes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexentries</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">glob_toctrees</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numbered_toctrees</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">purge_doc</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dlfiles</span><span class="o">.</span><span class="n">purge_doc</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">subfn</span><span class="p">,</span> <span class="n">fnset</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">files_to_rebuild</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="n">fnset</span><span class="o">.</span><span class="n">discard</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">fnset</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_rebuild</span><span class="p">[</span><span class="n">subfn</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="n">_ignore</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">fn</span> <span class="o">==</span> <span class="n">docname</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">citations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">version</span><span class="p">,</span> <span class="n">changes</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">versionchanges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">new</span> <span class="o">=</span> <span class="p">[</span><span class="n">change</span> <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span> <span class="k">if</span> <span class="n">change</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">docname</span><span class="p">]</span>
                <span class="n">changes</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">new</span>

        <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">domain</span><span class="o">.</span><span class="n">clear_doc</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">merge_info_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnames</span><span class="p">,</span> <span class="n">other</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Merge global information gathered about *docnames* while reading them</span>
<span class="sd">        from the *other* environment.</span>

<span class="sd">        This possibly comes from a parallel build process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">docnames</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">docnames</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">docname</span> <span class="ow">in</span> <span class="n">docnames</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">all_docs</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">all_docs</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">docname</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">reread_always</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">reread_always</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">docname</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">dependencies</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">dependencies</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">titles</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">longtitles</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">longtitles</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tocs</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">tocs</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toc_num_entries</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">toc_num_entries</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span>
            <span class="c1"># toc_secnumbers and toc_fignumbers are not assigned during read</span>
            <span class="k">if</span> <span class="n">docname</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">toctree_includes</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">toctree_includes</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">toctree_includes</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexentries</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">other</span><span class="o">.</span><span class="n">indexentries</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">docname</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">glob_toctrees</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">glob_toctrees</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">docname</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">numbered_toctrees</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">numbered_toctrees</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">merge_other</span><span class="p">(</span><span class="n">docnames</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">images</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dlfiles</span><span class="o">.</span><span class="n">merge_other</span><span class="p">(</span><span class="n">docnames</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">dlfiles</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">subfn</span><span class="p">,</span> <span class="n">fnset</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">files_to_rebuild</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files_to_rebuild</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">subfn</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">fnset</span> <span class="o">&amp;</span> <span class="n">docnames</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># XXX duplicates?</span>
            <span class="k">if</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">docnames</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">citations</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span>
        <span class="k">for</span> <span class="n">version</span><span class="p">,</span> <span class="n">changes</span> <span class="ow">in</span> <span class="n">other</span><span class="o">.</span><span class="n">versionchanges</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">versionchanges</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
                <span class="n">change</span> <span class="k">for</span> <span class="n">change</span> <span class="ow">in</span> <span class="n">changes</span> <span class="k">if</span> <span class="n">change</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">docnames</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">domainname</span><span class="p">,</span> <span class="n">domain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">domain</span><span class="o">.</span><span class="n">merge_domaindata</span><span class="p">(</span><span class="n">docnames</span><span class="p">,</span> <span class="n">other</span><span class="o">.</span><span class="n">domaindata</span><span class="p">[</span><span class="n">domainname</span><span class="p">])</span>
        <span class="n">app</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;env-merge-info&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">docnames</span><span class="p">,</span> <span class="n">other</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">path2doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the docname for the filename if the file is document.</span>

<span class="sd">        *filename* should be absolute or relative to the source directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">):</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:]</span>
        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">source_suffix</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">fnmatch</span><span class="o">.</span><span class="n">fnmatch</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s1">&#39;*&#39;</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">filename</span><span class="p">[:</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">suffix</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># the file does not have docname</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">doc2path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the filename for the document name.</span>

<span class="sd">        If *base* is True, return absolute path under self.srcdir.</span>
<span class="sd">        If *base* is None, return relative path to self.srcdir.</span>
<span class="sd">        If *base* is a path string, return absolute path under that.</span>
<span class="sd">        If *suffix* is not None, add it instead of config.source_suffix.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">docname</span> <span class="o">=</span> <span class="n">docname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">SEP</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">sep</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">suffix</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">candidate_suffix</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">source_suffix</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">docname</span><span class="p">)</span> <span class="o">+</span>
                               <span class="n">candidate_suffix</span><span class="p">):</span>
                    <span class="n">suffix</span> <span class="o">=</span> <span class="n">candidate_suffix</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># document does not exist</span>
                <span class="n">suffix</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">source_suffix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">docname</span><span class="p">)</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="k">elif</span> <span class="n">base</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">docname</span> <span class="o">+</span> <span class="n">suffix</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">docname</span><span class="p">)</span> <span class="o">+</span> <span class="n">suffix</span>

    <span class="k">def</span> <span class="nf">relfn2path</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">docname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return paths to a file referenced from a document, relative to</span>
<span class="sd">        documentation root and absolute.</span>

<span class="sd">        In the input &quot;filename&quot;, absolute filenames are taken as relative to the</span>
<span class="sd">        source dir, while relative filenames are relative to the dir of the</span>
<span class="sd">        containing document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">filename</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">sep</span><span class="p">):</span>
            <span class="n">rel_fn</span> <span class="o">=</span> <span class="n">filename</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">docdir</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">docname</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">docname</span><span class="p">,</span>
                                                <span class="n">base</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
            <span class="n">rel_fn</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">docdir</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># the path.abspath() might seem redundant, but otherwise artifacts</span>
            <span class="c1"># such as &quot;..&quot; will remain in the path</span>
            <span class="k">return</span> <span class="n">rel_fn</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">rel_fn</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="c1"># the source directory is a bytestring with non-ASCII characters;</span>
            <span class="c1"># let&#39;s try to encode the rel_fn in the file system encoding</span>
            <span class="n">enc_rel_fn</span> <span class="o">=</span> <span class="n">rel_fn</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">getfilesystemencoding</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">rel_fn</span><span class="p">,</span> <span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">enc_rel_fn</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">find_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find all source files in the source dir and put them in</span>
<span class="sd">        self.found_docs.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">matchers</span> <span class="o">=</span> <span class="n">compile_matchers</span><span class="p">(</span>
            <span class="n">config</span><span class="o">.</span><span class="n">exclude_patterns</span><span class="p">[:]</span> <span class="o">+</span>
            <span class="n">config</span><span class="o">.</span><span class="n">templates_path</span> <span class="o">+</span>
            <span class="n">config</span><span class="o">.</span><span class="n">html_extra_path</span> <span class="o">+</span>
            <span class="p">[</span><span class="s1">&#39;**/_sources&#39;</span><span class="p">,</span> <span class="s1">&#39;.#*&#39;</span><span class="p">,</span> <span class="s1">&#39;**/.#*&#39;</span><span class="p">,</span> <span class="s1">&#39;*.lproj/**&#39;</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">found_docs</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">docname</span> <span class="ow">in</span> <span class="n">get_matching_docs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">source_suffix</span><span class="p">,</span>
                                         <span class="n">exclude_matchers</span><span class="o">=</span><span class="n">matchers</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">docname</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">found_docs</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="s2">&quot;document not readable. Ignored.&quot;</span><span class="p">)</span>

        <span class="c1"># add catalog mo file dependency</span>
        <span class="k">for</span> <span class="n">docname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_docs</span><span class="p">:</span>
            <span class="n">catalog_files</span> <span class="o">=</span> <span class="n">find_catalog_files</span><span class="p">(</span>
                <span class="n">docname</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">locale_dirs</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">language</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gettext_compact</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">catalog_files</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_outdated_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config_changed</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return (added, changed, removed) sets.&quot;&quot;&quot;</span>
        <span class="c1"># clear all files no longer present</span>
        <span class="n">removed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_docs</span><span class="p">)</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_docs</span>

        <span class="n">added</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">changed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">config_changed</span><span class="p">:</span>
            <span class="c1"># config values affect e.g. substitutions</span>
            <span class="n">added</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_docs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">docname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_docs</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">docname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_docs</span><span class="p">:</span>
                    <span class="n">added</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># if the doctree file is not there, rebuild</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doctreedir</span><span class="p">,</span>
                                                 <span class="s1">&#39;.doctree&#39;</span><span class="p">)):</span>
                    <span class="n">changed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># check the &quot;reread always&quot; list</span>
                <span class="k">if</span> <span class="n">docname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">reread_always</span><span class="p">:</span>
                    <span class="n">changed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># check the mtime of the document</span>
                <span class="n">mtime</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_docs</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span>
                <span class="n">newmtime</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">docname</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">newmtime</span> <span class="o">&gt;</span> <span class="n">mtime</span><span class="p">:</span>
                    <span class="n">changed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="c1"># finally, check the mtime of dependencies</span>
                <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="p">()):</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># this will do the right thing when dep is absolute too</span>
                        <span class="n">deppath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">dep</span><span class="p">)</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">deppath</span><span class="p">):</span>
                            <span class="n">changed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
                            <span class="k">break</span>
                        <span class="n">depmtime</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="n">deppath</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">depmtime</span> <span class="o">&gt;</span> <span class="n">mtime</span><span class="p">:</span>
                            <span class="n">changed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
                            <span class="k">break</span>
                    <span class="k">except</span> <span class="ne">EnvironmentError</span><span class="p">:</span>
                        <span class="c1"># give it another chance</span>
                        <span class="n">changed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
                        <span class="k">break</span>

        <span class="k">return</span> <span class="n">added</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">removed</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">,</span> <span class="n">srcdir</span><span class="p">,</span> <span class="n">doctreedir</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;(Re-)read all files new or changed since last update.</span>

<span class="sd">        Store all environment docnames in the canonical format (ie using SEP as</span>
<span class="sd">        a separator in place of os.path.sep).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">config_changed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;[new config] &#39;</span>
            <span class="n">config_changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># check if a config value was changed that affects how</span>
            <span class="c1"># doctrees are read</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">descr</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">values</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">descr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;env&#39;</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">!=</span> <span class="n">config</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;[config changed] &#39;</span>
                    <span class="n">config_changed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="c1"># this value is not covered by the above loop because it is handled</span>
            <span class="c1"># specially by the config class</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">extensions</span> <span class="o">!=</span> <span class="n">config</span><span class="o">.</span><span class="n">extensions</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;[extensions changed] &#39;</span>
                <span class="n">config_changed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="c1"># the source and doctree directories may have been relocated</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span> <span class="o">=</span> <span class="n">srcdir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">doctreedir</span> <span class="o">=</span> <span class="n">doctreedir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">find_files</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

        <span class="c1"># this cache also needs to be updated every time</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_nitpick_ignore</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nitpick_ignore</span><span class="p">)</span>

        <span class="n">app</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">bold</span><span class="p">(</span><span class="s1">&#39;updating environment: &#39;</span><span class="p">),</span> <span class="n">nonl</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">added</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">removed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_outdated_files</span><span class="p">(</span><span class="n">config_changed</span><span class="p">)</span>

        <span class="c1"># allow user intervention as well</span>
        <span class="k">for</span> <span class="n">docs</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;env-get-outdated&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">added</span><span class="p">,</span> <span class="n">changed</span><span class="p">,</span> <span class="n">removed</span><span class="p">):</span>
            <span class="n">changed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">docs</span><span class="p">)</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_docs</span><span class="p">)</span>

        <span class="c1"># if files were added or removed, all documents with globbed toctrees</span>
        <span class="c1"># must be reread</span>
        <span class="k">if</span> <span class="n">added</span> <span class="ow">or</span> <span class="n">removed</span><span class="p">:</span>
            <span class="c1"># ... but not those that already were removed</span>
            <span class="n">changed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">glob_toctrees</span> <span class="o">&amp;</span> <span class="bp">self</span><span class="o">.</span><span class="n">found_docs</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> added, </span><span class="si">%s</span><span class="s1"> changed, </span><span class="si">%s</span><span class="s1"> removed&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">added</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">changed</span><span class="p">),</span>
                                                     <span class="nb">len</span><span class="p">(</span><span class="n">removed</span><span class="p">))</span>
        <span class="n">app</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>

        <span class="c1"># clear all files no longer present</span>
        <span class="k">for</span> <span class="n">docname</span> <span class="ow">in</span> <span class="n">removed</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;env-purge-doc&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_doc</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>

        <span class="c1"># read all new and changed files</span>
        <span class="n">docnames</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">added</span> <span class="o">|</span> <span class="n">changed</span><span class="p">)</span>
        <span class="c1"># allow changing and reordering the list of docs to read</span>
        <span class="n">app</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;env-before-read-docs&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">docnames</span><span class="p">)</span>

        <span class="c1"># check if we should do parallel or serial read</span>
        <span class="n">par_ok</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">parallel_available</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">docnames</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">app</span><span class="o">.</span><span class="n">parallel</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">par_ok</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">for</span> <span class="n">extname</span><span class="p">,</span> <span class="n">md</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">_extension_metadata</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">ext_ok</span> <span class="o">=</span> <span class="n">md</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;parallel_read_safe&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">ext_ok</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">ext_ok</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">app</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;the </span><span class="si">%s</span><span class="s1"> extension does not declare if it &#39;</span>
                             <span class="s1">&#39;is safe for parallel reading, assuming it &#39;</span>
                             <span class="s1">&#39;isn</span><span class="se">\&#39;</span><span class="s1">t - please ask the extension author to &#39;</span>
                             <span class="s1">&#39;check and make it explicit&#39;</span> <span class="o">%</span> <span class="n">extname</span><span class="p">)</span>
                    <span class="n">app</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;doing serial read&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">app</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="s1">&#39;the </span><span class="si">%s</span><span class="s1"> extension is not safe for parallel &#39;</span>
                             <span class="s1">&#39;reading, doing serial read&#39;</span> <span class="o">%</span> <span class="n">extname</span><span class="p">)</span>
                <span class="n">par_ok</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">par_ok</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_parallel</span><span class="p">(</span><span class="n">docnames</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">nproc</span><span class="o">=</span><span class="n">app</span><span class="o">.</span><span class="n">parallel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_read_serial</span><span class="p">(</span><span class="n">docnames</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">master_doc</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_docs</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SphinxError</span><span class="p">(</span><span class="s1">&#39;master file </span><span class="si">%s</span><span class="s1"> not found&#39;</span> <span class="o">%</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">master_doc</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">retval</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;env-updated&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">retval</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">docnames</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">retval</span><span class="p">)</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">docnames</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_serial</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnames</span><span class="p">,</span> <span class="n">app</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">docname</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">status_iterator</span><span class="p">(</span><span class="n">docnames</span><span class="p">,</span> <span class="s1">&#39;reading sources... &#39;</span><span class="p">,</span>
                                           <span class="n">purple</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">docnames</span><span class="p">)):</span>
            <span class="c1"># remove all inventory entries for that file</span>
            <span class="n">app</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;env-purge-doc&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_doc</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">read_doc</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_read_parallel</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docnames</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">nproc</span><span class="p">):</span>
        <span class="c1"># clear all outdated docs at once</span>
        <span class="k">for</span> <span class="n">docname</span> <span class="ow">in</span> <span class="n">docnames</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;env-purge-doc&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">clear_doc</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">read_process</span><span class="p">(</span><span class="n">docs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_warnfunc</span><span class="p">(</span><span class="k">lambda</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">warnings</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)))</span>
            <span class="k">for</span> <span class="n">docname</span> <span class="ow">in</span> <span class="n">docs</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">read_doc</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>
            <span class="c1"># allow pickling self to send it back</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">set_warnfunc</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">values</span>
            <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
            <span class="k">return</span> <span class="bp">self</span>

        <span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">otherenv</span><span class="p">):</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">otherenv</span><span class="o">.</span><span class="n">warnings</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">merge_info_from</span><span class="p">(</span><span class="n">docs</span><span class="p">,</span> <span class="n">otherenv</span><span class="p">,</span> <span class="n">app</span><span class="p">)</span>

        <span class="n">tasks</span> <span class="o">=</span> <span class="n">ParallelTasks</span><span class="p">(</span><span class="n">nproc</span><span class="p">)</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="n">make_chunks</span><span class="p">(</span><span class="n">docnames</span><span class="p">,</span> <span class="n">nproc</span><span class="p">)</span>

        <span class="n">warnings</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">app</span><span class="o">.</span><span class="n">status_iterator</span><span class="p">(</span>
                <span class="n">chunks</span><span class="p">,</span> <span class="s1">&#39;reading sources... &#39;</span><span class="p">,</span> <span class="n">purple</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunks</span><span class="p">)):</span>
            <span class="n">tasks</span><span class="o">.</span><span class="n">add_task</span><span class="p">(</span><span class="n">read_process</span><span class="p">,</span> <span class="n">chunk</span><span class="p">,</span> <span class="n">merge</span><span class="p">)</span>

        <span class="c1"># make sure all threads have finished</span>
        <span class="n">app</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">bold</span><span class="p">(</span><span class="s1">&#39;waiting for workers...&#39;</span><span class="p">))</span>
        <span class="n">tasks</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">warning</span><span class="p">,</span> <span class="n">kwargs</span> <span class="ow">in</span> <span class="n">warnings</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_warnfunc</span><span class="p">(</span><span class="o">*</span><span class="n">warning</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check_dependents</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">already</span><span class="p">):</span>
        <span class="n">to_rewrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_section_numbers</span><span class="p">()</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">assign_figure_numbers</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">docname</span> <span class="ow">in</span> <span class="nb">set</span><span class="p">(</span><span class="n">to_rewrite</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">docname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">already</span><span class="p">:</span>
                <span class="k">yield</span> <span class="n">docname</span>

    <span class="c1"># --------- SINGLE FILE READING --------------------------------------------</span>

    <span class="k">def</span> <span class="nf">warn_and_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">error</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Custom decoding error handler that warns and replaces.&quot;&quot;&quot;</span>
        <span class="n">linestart</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">rfind</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="n">lineend</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">start</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">lineend</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">lineend</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">object</span><span class="p">)</span>
        <span class="n">lineno</span> <span class="o">=</span> <span class="n">error</span><span class="o">.</span><span class="n">object</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">b</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">start</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docname</span><span class="p">,</span> <span class="s1">&#39;undecodable source characters, &#39;</span>
                  <span class="s1">&#39;replacing with &quot;?&quot;: </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span>
                  <span class="p">(</span><span class="n">error</span><span class="o">.</span><span class="n">object</span><span class="p">[</span><span class="n">linestart</span><span class="o">+</span><span class="mi">1</span><span class="p">:</span><span class="n">error</span><span class="o">.</span><span class="n">start</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="s1">&#39;&gt;&gt;&gt;&#39;</span> <span class="o">+</span>
                   <span class="n">error</span><span class="o">.</span><span class="n">object</span><span class="p">[</span><span class="n">error</span><span class="o">.</span><span class="n">start</span><span class="p">:</span><span class="n">error</span><span class="o">.</span><span class="n">end</span><span class="p">]</span> <span class="o">+</span> <span class="n">b</span><span class="s1">&#39;&lt;&lt;&lt;&#39;</span> <span class="o">+</span>
                   <span class="n">error</span><span class="o">.</span><span class="n">object</span><span class="p">[</span><span class="n">error</span><span class="o">.</span><span class="n">end</span><span class="p">:</span><span class="n">lineend</span><span class="p">]),</span> <span class="n">lineno</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="s1">u&#39;?&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">lookup_domain_element</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Lookup a markup element (directive or role), given its name which can</span>
<span class="sd">        be a full name (with domain).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="c1"># explicit domain given?</span>
        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
            <span class="n">domain_name</span><span class="p">,</span> <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">domain_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">:</span>
                <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">domain_name</span><span class="p">]</span>
                <span class="n">element</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">domain</span><span class="p">,</span> <span class="nb">type</span><span class="p">)(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">element</span><span class="p">,</span> <span class="p">[]</span>
        <span class="c1"># else look in the default domain</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">def_domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;default_domain&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">def_domain</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">element</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">def_domain</span><span class="p">,</span> <span class="nb">type</span><span class="p">)(</span><span class="n">name</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">element</span><span class="p">,</span> <span class="p">[]</span>
        <span class="c1"># always look in the std domain</span>
        <span class="n">element</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">],</span> <span class="nb">type</span><span class="p">)(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">element</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">element</span><span class="p">,</span> <span class="p">[]</span>
        <span class="k">raise</span> <span class="n">ElementLookupError</span>

    <span class="k">def</span> <span class="nf">patch_lookup_functions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Monkey-patch directive and role dispatch, so that domain-specific</span>
<span class="sd">        markup takes precedence.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">directive</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lang_module</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_domain_element</span><span class="p">(</span><span class="s1">&#39;directive&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ElementLookupError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">orig_directive_function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lang_module</span><span class="p">,</span> <span class="n">document</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">role</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lang_module</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">reporter</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lookup_domain_element</span><span class="p">(</span><span class="s1">&#39;role&#39;</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">ElementLookupError</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">orig_role_function</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">lang_module</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">reporter</span><span class="p">)</span>

        <span class="n">directives</span><span class="o">.</span><span class="n">directive</span> <span class="o">=</span> <span class="n">directive</span>
        <span class="n">roles</span><span class="o">.</span><span class="n">role</span> <span class="o">=</span> <span class="n">role</span>

    <span class="k">def</span> <span class="nf">read_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a file and add/update inventory entries for the doctree.&quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">temp_data</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">docname</span>
        <span class="c1"># defaults to the global default, but can be re-set in a document</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_data</span><span class="p">[</span><span class="s1">&#39;default_domain&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">primary_domain</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;input_encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">source_encoding</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;trim_footnote_reference_space&#39;</span><span class="p">]</span> <span class="o">=</span> \
            <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">trim_footnote_reference_space</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">[</span><span class="s1">&#39;gettext_compact&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">gettext_compact</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">patch_lookup_functions</span><span class="p">()</span>

        <span class="n">docutilsconf</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="s1">&#39;docutils.conf&#39;</span><span class="p">)</span>
        <span class="c1"># read docutils.conf from source dir, not from current dir</span>
        <span class="n">OptionParser</span><span class="o">.</span><span class="n">standard_config_files</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">docutilsconf</span>
        <span class="k">if</span> <span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">docutilsconf</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">note_dependency</span><span class="p">(</span><span class="n">docutilsconf</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_role</span><span class="p">:</span>
            <span class="n">role_fn</span><span class="p">,</span> <span class="n">messages</span> <span class="o">=</span> <span class="n">roles</span><span class="o">.</span><span class="n">role</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_role</span><span class="p">,</span> <span class="n">english</span><span class="p">,</span>
                                           <span class="mi">0</span><span class="p">,</span> <span class="n">dummy_reporter</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">role_fn</span><span class="p">:</span>
                <span class="n">roles</span><span class="o">.</span><span class="n">_roles</span><span class="p">[</span><span class="s1">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">role_fn</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="s1">&#39;default role </span><span class="si">%s</span><span class="s1"> not found&#39;</span> <span class="o">%</span>
                          <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">default_role</span><span class="p">)</span>

        <span class="n">codecs</span><span class="o">.</span><span class="n">register_error</span><span class="p">(</span><span class="s1">&#39;sphinx&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">warn_and_replace</span><span class="p">)</span>

        <span class="c1"># publish manually</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">SphinxStandaloneReader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="p">,</span> <span class="n">parsers</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">source_parsers</span><span class="p">)</span>
        <span class="n">pub</span> <span class="o">=</span> <span class="n">Publisher</span><span class="p">(</span><span class="n">reader</span><span class="o">=</span><span class="n">reader</span><span class="p">,</span>
                        <span class="n">writer</span><span class="o">=</span><span class="n">SphinxDummyWriter</span><span class="p">(),</span>
                        <span class="n">destination_class</span><span class="o">=</span><span class="n">NullOutput</span><span class="p">)</span>
        <span class="n">pub</span><span class="o">.</span><span class="n">set_components</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="s1">&#39;restructuredtext&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">pub</span><span class="o">.</span><span class="n">process_programmatic_settings</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">src_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">SphinxFileInput</span><span class="p">(</span><span class="n">app</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">source_path</span><span class="o">=</span><span class="n">src_path</span><span class="p">,</span>
                                 <span class="n">encoding</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">source_encoding</span><span class="p">)</span>
        <span class="n">pub</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">source</span>
        <span class="n">pub</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">_source</span> <span class="o">=</span> <span class="n">src_path</span>
        <span class="n">pub</span><span class="o">.</span><span class="n">set_destination</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">pub</span><span class="o">.</span><span class="n">publish</span><span class="p">()</span>
        <span class="n">doctree</span> <span class="o">=</span> <span class="n">pub</span><span class="o">.</span><span class="n">document</span>

        <span class="c1"># post-processing</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_messages</span><span class="p">(</span><span class="n">doctree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_dependencies</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_images</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_downloads</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_metadata</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_refonly_bullet_lists</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_title_from</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">note_indexentries_from</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">note_citations_from</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">build_toc_from</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">):</span>
            <span class="n">domain</span><span class="o">.</span><span class="n">process_doc</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>

        <span class="c1"># allow extension-specific post-processing</span>
        <span class="k">if</span> <span class="n">app</span><span class="p">:</span>
            <span class="n">app</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;doctree-read&#39;</span><span class="p">,</span> <span class="n">doctree</span><span class="p">)</span>

        <span class="c1"># store time of reading, for outdated files detection</span>
        <span class="c1"># (Some filesystems have coarse timestamp resolution;</span>
        <span class="c1"># therefore time.time() can be older than filesystem&#39;s timestamp.</span>
        <span class="c1"># For example, FAT32 has 2sec timestamp resolution.)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">all_docs</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span>
            <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="n">path</span><span class="o">.</span><span class="n">getmtime</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">docname</span><span class="p">)))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">versioning_condition</span><span class="p">:</span>
            <span class="n">old_doctree</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">versioning_compare</span><span class="p">:</span>
                <span class="c1"># get old doctree</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">doctreedir</span><span class="p">,</span> <span class="s1">&#39;.doctree&#39;</span><span class="p">),</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">old_doctree</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                    <span class="k">finally</span><span class="p">:</span>
                        <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">EnvironmentError</span><span class="p">:</span>
                    <span class="k">pass</span>

            <span class="c1"># add uids for versioning</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">versioning_compare</span> <span class="ow">or</span> <span class="n">old_doctree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">add_uids</span><span class="p">(</span><span class="n">doctree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versioning_condition</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">list</span><span class="p">(</span><span class="n">merge_doctrees</span><span class="p">(</span>
                    <span class="n">old_doctree</span><span class="p">,</span> <span class="n">doctree</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">versioning_condition</span><span class="p">))</span>

        <span class="c1"># make it picklable</span>
        <span class="n">doctree</span><span class="o">.</span><span class="n">reporter</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">doctree</span><span class="o">.</span><span class="n">transformer</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">doctree</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">warning_stream</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">doctree</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">doctree</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">record_dependencies</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">metanode</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">MetaBody</span><span class="o">.</span><span class="n">meta</span><span class="p">):</span>
            <span class="c1"># docutils&#39; meta nodes aren&#39;t picklable because the class is nested</span>
            <span class="n">metanode</span><span class="o">.</span><span class="n">__class__</span> <span class="o">=</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">meta</span>

        <span class="c1"># cleanup</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_data</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ref_context</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="n">roles</span><span class="o">.</span><span class="n">_roles</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># if a document has set a local default role</span>

        <span class="c1"># save the parsed doctree</span>
        <span class="n">doctree_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doctreedir</span><span class="p">,</span>
                                         <span class="s1">&#39;.doctree&#39;</span><span class="p">)</span>
        <span class="n">ensuredir</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">doctree_filename</span><span class="p">))</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">doctree_filename</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">doctree</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">pickle</span><span class="o">.</span><span class="n">HIGHEST_PROTOCOL</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="c1"># utilities to use while reading a document</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">docname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the docname of the document currently being parsed.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_data</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">currmodule</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Backwards compatible alias.  Will be removed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docname</span><span class="p">,</span> <span class="s1">&#39;env.currmodule is being referenced by an &#39;</span>
                  <span class="s1">&#39;extension; this API will be removed in the future&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;py:module&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">currclass</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Backwards compatible alias.  Will be removed.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docname</span><span class="p">,</span> <span class="s1">&#39;env.currclass is being referenced by an &#39;</span>
                  <span class="s1">&#39;extension; this API will be removed in the future&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">ref_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;py:class&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">new_serialno</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">category</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a serial number, e.g. for index entry targets.</span>

<span class="sd">        The number is guaranteed to be unique in the current document.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">category</span> <span class="o">+</span> <span class="s1">&#39;serialno&#39;</span>
        <span class="n">cur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">temp_data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">cur</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">cur</span>

    <span class="k">def</span> <span class="nf">note_dependency</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add *filename* as a dependency of the current document.</span>

<span class="sd">        This means that the document will be rebuilt if this file changes.</span>

<span class="sd">        *filename* should be absolute or relative to the source directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docname</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_included</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add *filename* as a included from other document.</span>

<span class="sd">        This means the document is not orphaned.</span>

<span class="sd">        *filename* should be absolute or relative to the source directory.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">included</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">path2doc</span><span class="p">(</span><span class="n">filename</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">note_reread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add the current document to the list of documents that will</span>
<span class="sd">        automatically be re-read at the next build.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reread_always</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">docname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">note_versionchange</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">lineno</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">versionchanges</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">version</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">temp_data</span><span class="p">[</span><span class="s1">&#39;docname&#39;</span><span class="p">],</span> <span class="n">lineno</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">ref_context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;py:module&#39;</span><span class="p">),</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">temp_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;object&#39;</span><span class="p">),</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()))</span>

    <span class="c1"># post-processing of read doctrees</span>

    <span class="k">def</span> <span class="nf">filter_messages</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doctree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Filter system messages from a doctree.&quot;&quot;&quot;</span>
        <span class="n">filterlevel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">keep_warnings</span> <span class="ow">and</span> <span class="mi">2</span> <span class="ow">or</span> <span class="mi">5</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">system_message</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;level&#39;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">filterlevel</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> [filtered system message]&#39;</span><span class="p">,</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">())</span>
                <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_dependencies</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process docutils-generated dependency info.&quot;&quot;&quot;</span>
        <span class="n">cwd</span> <span class="o">=</span> <span class="n">getcwd</span><span class="p">()</span>
        <span class="n">frompath</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">),</span> <span class="s1">&#39;dummy&#39;</span><span class="p">)</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="n">doctree</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">record_dependencies</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">deps</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">dep</span> <span class="ow">in</span> <span class="n">deps</span><span class="o">.</span><span class="n">list</span><span class="p">:</span>
            <span class="c1"># the dependency path is relative to the working dir, so get</span>
            <span class="c1"># one relative to the srcdir</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dep</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">):</span>
                <span class="n">dep</span> <span class="o">=</span> <span class="n">dep</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="n">fs_encoding</span><span class="p">)</span>
            <span class="n">relpath</span> <span class="o">=</span> <span class="n">relative_path</span><span class="p">(</span><span class="n">frompath</span><span class="p">,</span>
                                    <span class="n">path</span><span class="o">.</span><span class="n">normpath</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">cwd</span><span class="p">,</span> <span class="n">dep</span><span class="p">)))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">relpath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_downloads</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process downloadable file paths. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">addnodes</span><span class="o">.</span><span class="n">download_reference</span><span class="p">):</span>
            <span class="n">targetname</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;reftarget&#39;</span><span class="p">]</span>
            <span class="n">rel_filename</span><span class="p">,</span> <span class="n">filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relfn2path</span><span class="p">(</span><span class="n">targetname</span><span class="p">,</span> <span class="n">docname</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">rel_filename</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span><span class="s1">&#39;download file not readable: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">,</span>
                               <span class="n">node</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">uniquename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dlfiles</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
            <span class="n">node</span><span class="p">[</span><span class="s1">&#39;filename&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">uniquename</span>

    <span class="k">def</span> <span class="nf">process_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process and rewrite image URIs.&quot;&quot;&quot;</span>
        <span class="k">def</span> <span class="nf">collect_candidates</span><span class="p">(</span><span class="n">imgpath</span><span class="p">,</span> <span class="n">candidates</span><span class="p">):</span>
            <span class="n">globbed</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="n">glob</span><span class="p">(</span><span class="n">imgpath</span><span class="p">):</span>
                <span class="n">new_imgpath</span> <span class="o">=</span> <span class="n">relative_path</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="s1">&#39;dummy&#39;</span><span class="p">),</span>
                                            <span class="n">filename</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">mimetype</span> <span class="o">=</span> <span class="n">guess_mimetype</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">mimetype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">candidates</span><span class="p">:</span>
                        <span class="n">globbed</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">mimetype</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_imgpath</span><span class="p">)</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">OSError</span><span class="p">,</span> <span class="ne">IOError</span><span class="p">)</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span><span class="s1">&#39;image file </span><span class="si">%s</span><span class="s1"> not readable: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                   <span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">err</span><span class="p">),</span> <span class="n">node</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">globbed</span><span class="p">):</span>
                <span class="n">candidates</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="nb">len</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># select by similarity</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">image</span><span class="p">):</span>
            <span class="c1"># Map the mimetype to the corresponding image.  The writer may</span>
            <span class="c1"># choose the best image from these candidates.  The special key * is</span>
            <span class="c1"># set if there is only single candidate to be used by a writer.</span>
            <span class="c1"># The special key ? is set for nonlocal URIs.</span>
            <span class="n">node</span><span class="p">[</span><span class="s1">&#39;candidates&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">candidates</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">imguri</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">imguri</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;data:&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span><span class="s1">&#39;image data URI found. some builders might not support&#39;</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">subtype</span><span class="o">=</span><span class="s1">&#39;data_uri&#39;</span><span class="p">)</span>
                <span class="n">candidates</span><span class="p">[</span><span class="s1">&#39;?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imguri</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="n">imguri</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;://&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span><span class="s1">&#39;nonlocal image URI found: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">imguri</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span>
                               <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;image&#39;</span><span class="p">,</span> <span class="n">subtype</span><span class="o">=</span><span class="s1">&#39;nonlocal_uri&#39;</span><span class="p">)</span>
                <span class="n">candidates</span><span class="p">[</span><span class="s1">&#39;?&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">imguri</span>
                <span class="k">continue</span>
            <span class="n">rel_imgpath</span><span class="p">,</span> <span class="n">full_imgpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relfn2path</span><span class="p">(</span><span class="n">imguri</span><span class="p">,</span> <span class="n">docname</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
                <span class="c1"># substitute figures (ex. foo.png -&gt; foo.en.png)</span>
                <span class="n">i18n_full_imgpath</span> <span class="o">=</span> <span class="n">search_image_for_language</span><span class="p">(</span><span class="n">full_imgpath</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i18n_full_imgpath</span> <span class="o">!=</span> <span class="n">full_imgpath</span><span class="p">:</span>
                    <span class="n">full_imgpath</span> <span class="o">=</span> <span class="n">i18n_full_imgpath</span>
                    <span class="n">rel_imgpath</span> <span class="o">=</span> <span class="n">relative_path</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="s1">&#39;dummy&#39;</span><span class="p">),</span>
                                                <span class="n">i18n_full_imgpath</span><span class="p">)</span>
            <span class="c1"># set imgpath as default URI</span>
            <span class="n">node</span><span class="p">[</span><span class="s1">&#39;uri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_imgpath</span>
            <span class="k">if</span> <span class="n">rel_imgpath</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">extsep</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">language</span><span class="p">:</span>
                    <span class="c1"># Search language-specific figures at first</span>
                    <span class="n">i18n_imguri</span> <span class="o">=</span> <span class="n">get_image_filename_for_language</span><span class="p">(</span><span class="n">imguri</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">full_i18n_imgpath</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">relfn2path</span><span class="p">(</span><span class="n">i18n_imguri</span><span class="p">,</span> <span class="n">docname</span><span class="p">)</span>
                    <span class="n">collect_candidates</span><span class="p">(</span><span class="n">full_i18n_imgpath</span><span class="p">,</span> <span class="n">candidates</span><span class="p">)</span>

                <span class="n">collect_candidates</span><span class="p">(</span><span class="n">full_imgpath</span><span class="p">,</span> <span class="n">candidates</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">candidates</span><span class="p">[</span><span class="s1">&#39;*&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rel_imgpath</span>

            <span class="c1"># map image paths to unique image names (so that they can be put</span>
            <span class="c1"># into a single directory)</span>
            <span class="k">for</span> <span class="n">imgpath</span> <span class="ow">in</span> <span class="n">itervalues</span><span class="p">(</span><span class="n">candidates</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">dependencies</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">imgpath</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">access</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">srcdir</span><span class="p">,</span> <span class="n">imgpath</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">R_OK</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span><span class="s1">&#39;image file not readable: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">imgpath</span><span class="p">,</span>
                                   <span class="n">node</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="o">.</span><span class="n">add_file</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">imgpath</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">process_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the docinfo part of the doctree as metadata.</span>

<span class="sd">        Keep processing minimal -- just return what docutils says.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">docinfo</span> <span class="o">=</span> <span class="n">doctree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="c1"># probably an empty document</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">docinfo</span><span class="o">.</span><span class="n">__class__</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">nodes</span><span class="o">.</span><span class="n">docinfo</span><span class="p">:</span>
            <span class="c1"># nothing to see here</span>
            <span class="k">return</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">docinfo</span><span class="p">:</span>
            <span class="c1"># nodes are multiply inherited...</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">authors</span><span class="p">):</span>
                <span class="n">md</span><span class="p">[</span><span class="s1">&#39;authors&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">author</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span> <span class="k">for</span> <span class="n">author</span> <span class="ow">in</span> <span class="n">node</span><span class="p">]</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">TextElement</span><span class="p">):</span>  <span class="c1"># e.g. author</span>
                <span class="n">md</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">__class__</span><span class="o">.</span><span class="n">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">body</span> <span class="o">=</span> <span class="n">node</span>
                <span class="n">md</span><span class="p">[</span><span class="n">name</span><span class="o">.</span><span class="n">astext</span><span class="p">()]</span> <span class="o">=</span> <span class="n">body</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">md</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;tocdepth&#39;</span><span class="p">,):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">md</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="k">del</span> <span class="n">doctree</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">process_refonly_bullet_lists</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change refonly bullet lists to use compact_paragraphs.</span>

<span class="sd">        Specifically implemented for &#39;Indices and Tables&#39; section, which looks</span>
<span class="sd">        odd when html_compact_lists is false.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">html_compact_lists</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">class</span> <span class="nc">RefOnlyListChecker</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">GenericNodeVisitor</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Raise `nodes.NodeFound` if non-simple list item is encountered.</span>

<span class="sd">            Here &#39;simple&#39; means a list item containing only a paragraph with a</span>
<span class="sd">            single reference in it.</span>
<span class="sd">            &quot;&quot;&quot;</span>

            <span class="k">def</span> <span class="nf">default_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NodeFound</span>

            <span class="k">def</span> <span class="nf">visit_bullet_list</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
                <span class="k">pass</span>

            <span class="k">def</span> <span class="nf">visit_list_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
                <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Invisible</span><span class="p">):</span>
                        <span class="n">children</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">children</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NodeFound</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NodeFound</span>
                <span class="n">para</span> <span class="o">=</span> <span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">para</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NodeFound</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">pending_xref</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NodeFound</span>
                <span class="k">raise</span> <span class="n">nodes</span><span class="o">.</span><span class="n">SkipChildren</span>

            <span class="k">def</span> <span class="nf">invisible_visit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">):</span>
                <span class="sd">&quot;&quot;&quot;Invisible nodes should be ignored.&quot;&quot;&quot;</span>
                <span class="k">pass</span>

        <span class="k">def</span> <span class="nf">check_refonly_list</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Check for list with only references in it.&quot;&quot;&quot;</span>
            <span class="n">visitor</span> <span class="o">=</span> <span class="n">RefOnlyListChecker</span><span class="p">(</span><span class="n">doctree</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">node</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">nodes</span><span class="o">.</span><span class="n">NodeFound</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">check_refonly_list</span><span class="p">(</span><span class="n">node</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">list_item</span><span class="p">):</span>
                    <span class="n">para</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ref</span> <span class="o">=</span> <span class="n">para</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">compact_para</span> <span class="o">=</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">compact_paragraph</span><span class="p">()</span>
                    <span class="n">compact_para</span> <span class="o">+=</span> <span class="n">ref</span>
                    <span class="n">item</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">para</span><span class="p">,</span> <span class="n">compact_para</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">create_title_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a title node to the document (just copy the first section title),</span>
<span class="sd">        and store that title in the environment.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">titlenode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
        <span class="n">longtitlenode</span> <span class="o">=</span> <span class="n">titlenode</span>
        <span class="c1"># explicit title set with title directive; use this only for</span>
        <span class="c1"># the &lt;title&gt; tag in HTML output</span>
        <span class="k">if</span> <span class="s1">&#39;title&#39;</span> <span class="ow">in</span> <span class="n">document</span><span class="p">:</span>
            <span class="n">longtitlenode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">longtitlenode</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">document</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">])</span>
        <span class="c1"># look for first section title and use that as the title</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">section</span><span class="p">):</span>
            <span class="n">visitor</span> <span class="o">=</span> <span class="n">SphinxContentsFilter</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
            <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">walkabout</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
            <span class="n">titlenode</span> <span class="o">+=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">get_entry_text</span><span class="p">()</span>
            <span class="k">break</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># document has no title</span>
            <span class="n">titlenode</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="s1">&#39;&lt;no title&gt;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">titlenode</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">longtitles</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">longtitlenode</span>

    <span class="k">def</span> <span class="nf">note_indexentries_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="n">entries</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">indexentries</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">addnodes</span><span class="o">.</span><span class="n">index</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">]:</span>
                    <span class="n">split_index_msg</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">exc</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span><span class="n">exc</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span><span class="p">:</span>
                        <span class="c1"># Since 1.4: new index structure including index_key (5th column)</span>
                        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span> <span class="o">+</span> <span class="p">(</span><span class="kc">None</span><span class="p">,))</span>

    <span class="k">def</span> <span class="nf">note_citations_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">document</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">citation</span><span class="p">):</span>
            <span class="n">label</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">label</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">citations</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span><span class="s1">&#39;duplicate citation </span><span class="si">%s</span><span class="s1">, &#39;</span> <span class="o">%</span> <span class="n">label</span> <span class="o">+</span>
                               <span class="s1">&#39;other instance in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span>
                                   <span class="bp">self</span><span class="o">.</span><span class="n">citations</span><span class="p">[</span><span class="n">label</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">node</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">citations</span><span class="p">[</span><span class="n">label</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">note_toctree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">toctreenode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Note a TOC tree directive in a document and gather information about</span>
<span class="sd">        file relations from it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">toctreenode</span><span class="p">[</span><span class="s1">&#39;glob&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">glob_toctrees</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">toctreenode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numbered&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">numbered_toctrees</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
        <span class="n">includefiles</span> <span class="o">=</span> <span class="n">toctreenode</span><span class="p">[</span><span class="s1">&#39;includefiles&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">includefile</span> <span class="ow">in</span> <span class="n">includefiles</span><span class="p">:</span>
            <span class="c1"># note that if the included file is rebuilt, this one must be</span>
            <span class="c1"># too (since the TOC of the included file could have changed)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">files_to_rebuild</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">includefile</span><span class="p">,</span> <span class="nb">set</span><span class="p">())</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toctree_includes</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">includefiles</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">build_toc_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">document</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Build a TOC from the doctree and store it in the inventory.&quot;&quot;&quot;</span>
        <span class="n">numentries</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># nonlocal again...</span>

        <span class="k">def</span> <span class="nf">traverse_in_section</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Like traverse(), but stay within the same section.&quot;&quot;&quot;</span>
            <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">cls</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">section</span><span class="p">):</span>
                    <span class="k">continue</span>
                <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">traverse_in_section</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">cls</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">result</span>

        <span class="k">def</span> <span class="nf">build_toc</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sectionnode</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
                <span class="c1"># find all toctree nodes in this section and add them</span>
                <span class="c1"># to the toc (just copying the toctree node which is then</span>
                <span class="c1"># resolved in self.get_and_resolve_doctree)</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sectionnode</span><span class="p">,</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">only</span><span class="p">):</span>
                    <span class="n">onlynode</span> <span class="o">=</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">only</span><span class="p">(</span><span class="n">expr</span><span class="o">=</span><span class="n">sectionnode</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">])</span>
                    <span class="n">blist</span> <span class="o">=</span> <span class="n">build_toc</span><span class="p">(</span><span class="n">sectionnode</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">blist</span><span class="p">:</span>
                        <span class="n">onlynode</span> <span class="o">+=</span> <span class="n">blist</span><span class="o">.</span><span class="n">children</span>
                        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">onlynode</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sectionnode</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">section</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">toctreenode</span> <span class="ow">in</span> <span class="n">traverse_in_section</span><span class="p">(</span><span class="n">sectionnode</span><span class="p">,</span>
                                                           <span class="n">addnodes</span><span class="o">.</span><span class="n">toctree</span><span class="p">):</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">toctreenode</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
                        <span class="c1"># important: do the inventory stuff</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">note_toctree</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">toctreenode</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">title</span> <span class="o">=</span> <span class="n">sectionnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># copy the contents of the section title, but without references</span>
                <span class="c1"># and unnecessary stuff</span>
                <span class="n">visitor</span> <span class="o">=</span> <span class="n">SphinxContentsFilter</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
                <span class="n">title</span><span class="o">.</span><span class="n">walkabout</span><span class="p">(</span><span class="n">visitor</span><span class="p">)</span>
                <span class="n">nodetext</span> <span class="o">=</span> <span class="n">visitor</span><span class="o">.</span><span class="n">get_entry_text</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">numentries</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                    <span class="c1"># for the very first toc entry, don&#39;t add an anchor</span>
                    <span class="c1"># as it is the file&#39;s title anyway</span>
                    <span class="n">anchorname</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">anchorname</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">sectionnode</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">numentries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c1"># make these nodes:</span>
                <span class="c1"># list_item -&gt; compact_paragraph -&gt; reference</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span>
                    <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">refuri</span><span class="o">=</span><span class="n">docname</span><span class="p">,</span>
                    <span class="n">anchorname</span><span class="o">=</span><span class="n">anchorname</span><span class="p">,</span> <span class="o">*</span><span class="n">nodetext</span><span class="p">)</span>
                <span class="n">para</span> <span class="o">=</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">compact_paragraph</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
                <span class="n">item</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">list_item</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">para</span><span class="p">)</span>
                <span class="n">sub_item</span> <span class="o">=</span> <span class="n">build_toc</span><span class="p">(</span><span class="n">sectionnode</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">item</span> <span class="o">+=</span> <span class="n">sub_item</span>
                <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">entries</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">entries</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="n">toc</span> <span class="o">=</span> <span class="n">build_toc</span><span class="p">(</span><span class="n">document</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">toc</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tocs</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">toc</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tocs</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc_num_entries</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="n">numentries</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">get_toc_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">builder</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a TOC nodetree -- for use on the same page only!&quot;&quot;&quot;</span>
        <span class="n">tocdepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tocdepth&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">toc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tocs</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_toctree_prune</span><span class="p">(</span><span class="n">toc</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tocdepth</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="c1"># the document does not exist anymore: return a dummy node that</span>
            <span class="c1"># renders to nothing</span>
            <span class="k">return</span> <span class="n">nodes</span><span class="o">.</span><span class="n">paragraph</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_only_nodes</span><span class="p">(</span><span class="n">toc</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">docname</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">toc</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">):</span>
            <span class="n">node</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;anchorname&#39;</span><span class="p">]</span> <span class="ow">or</span> <span class="s1">&#39;#&#39;</span>
        <span class="k">return</span> <span class="n">toc</span>

    <span class="k">def</span> <span class="nf">get_toctree_for</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">collapse</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the global TOC nodetree.&quot;&quot;&quot;</span>
        <span class="n">doctree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_doctree</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_doc</span><span class="p">)</span>
        <span class="n">toctrees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s1">&#39;includehidden&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;includehidden&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="s1">&#39;maxdepth&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwds</span><span class="p">:</span>
            <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;maxdepth&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">kwds</span><span class="p">[</span><span class="s1">&#39;collapse&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">collapse</span>
        <span class="k">for</span> <span class="n">toctreenode</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">addnodes</span><span class="o">.</span><span class="n">toctree</span><span class="p">):</span>
            <span class="n">toctree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_toctree</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">toctreenode</span><span class="p">,</span>
                                           <span class="n">prune</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">toctree</span><span class="p">:</span>
                <span class="n">toctrees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">toctree</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">toctrees</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">toctrees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">toctree</span> <span class="ow">in</span> <span class="n">toctrees</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">toctree</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span> <span class="nf">get_domain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">domainname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the domain instance with the specified name.</span>

<span class="sd">        Raises an ExtensionError if the domain is not registered.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">domainname</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ExtensionError</span><span class="p">(</span><span class="s1">&#39;Domain </span><span class="si">%r</span><span class="s1"> is not registered&#39;</span> <span class="o">%</span> <span class="n">domainname</span><span class="p">)</span>

    <span class="c1"># --------- RESOLVING REFERENCES AND TOCTREES ------------------------------</span>

    <span class="k">def</span> <span class="nf">get_doctree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the doctree for a file from the pickle and return it.&quot;&quot;&quot;</span>
        <span class="n">doctree_filename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">doctreedir</span><span class="p">,</span> <span class="s1">&#39;.doctree&#39;</span><span class="p">)</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">doctree_filename</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">doctree</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">doctree</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">env</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="n">doctree</span><span class="o">.</span><span class="n">reporter</span> <span class="o">=</span> <span class="n">Reporter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">doc2path</span><span class="p">(</span><span class="n">docname</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
                                    <span class="n">stream</span><span class="o">=</span><span class="n">WarningStream</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_warnfunc</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">doctree</span>

    <span class="k">def</span> <span class="nf">get_and_resolve_doctree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">doctree</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">prune_toctrees</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">includehidden</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the doctree from the pickle, resolve cross-references and</span>
<span class="sd">        toctrees and return it.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">doctree</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">doctree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_doctree</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>

        <span class="c1"># resolve all pending cross-references</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolve_references</span><span class="p">(</span><span class="n">doctree</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">builder</span><span class="p">)</span>

        <span class="c1"># now, resolve all toctree nodes</span>
        <span class="k">for</span> <span class="n">toctreenode</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">addnodes</span><span class="o">.</span><span class="n">toctree</span><span class="p">):</span>
            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolve_toctree</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">toctreenode</span><span class="p">,</span>
                                          <span class="n">prune</span><span class="o">=</span><span class="n">prune_toctrees</span><span class="p">,</span>
                                          <span class="n">includehidden</span><span class="o">=</span><span class="n">includehidden</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">result</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">toctreenode</span><span class="o">.</span><span class="n">replace_self</span><span class="p">([])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">toctreenode</span><span class="o">.</span><span class="n">replace_self</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">doctree</span>

    <span class="k">def</span> <span class="nf">_toctree_prune</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Utility: Cut a TOC at a specified depth.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">subnode</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">[:]:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="p">(</span><span class="n">addnodes</span><span class="o">.</span><span class="n">compact_paragraph</span><span class="p">,</span>
                                    <span class="n">nodes</span><span class="o">.</span><span class="n">list_item</span><span class="p">)):</span>
                <span class="c1"># for &lt;p&gt; and &lt;li&gt;, just recurse</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_toctree_prune</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">collapse</span><span class="p">)</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">):</span>
                <span class="c1"># for &lt;ul&gt;, determine if the depth is too large or if the</span>
                <span class="c1"># entry is to be collapsed</span>
                <span class="k">if</span> <span class="n">maxdepth</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="n">maxdepth</span><span class="p">:</span>
                    <span class="n">subnode</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="p">[])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># cull sub-entries whose parents aren&#39;t &#39;current&#39;</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">collapse</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span>
                            <span class="s1">&#39;iscurrent&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subnode</span><span class="o">.</span><span class="n">parent</span><span class="p">):</span>
                        <span class="n">subnode</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">subnode</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># recurse on visible children</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_toctree_prune</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span>  <span class="n">collapse</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">get_toctree_ancestors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">):</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">children</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toctree_includes</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">children</span><span class="p">:</span>
                <span class="n">parent</span><span class="p">[</span><span class="n">child</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span>
        <span class="n">ancestors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="n">docname</span>
        <span class="k">while</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">parent</span> <span class="ow">and</span> <span class="n">d</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ancestors</span><span class="p">:</span>
            <span class="n">ancestors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
            <span class="n">d</span> <span class="o">=</span> <span class="n">parent</span><span class="p">[</span><span class="n">d</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">ancestors</span>

    <span class="k">def</span> <span class="nf">resolve_toctree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">docname</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">toctree</span><span class="p">,</span> <span class="n">prune</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">maxdepth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">titles_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">collapse</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">includehidden</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resolve a *toctree* node into individual bullet lists with titles</span>
<span class="sd">        as items, returning None (if no containing titles are found) or</span>
<span class="sd">        a new node.</span>

<span class="sd">        If *prune* is True, the tree is pruned to *maxdepth*, or if that is 0,</span>
<span class="sd">        to the value of the *maxdepth* option on the *toctree* node.</span>
<span class="sd">        If *titles_only* is True, only toplevel document titles will be in the</span>
<span class="sd">        resulting tree.</span>
<span class="sd">        If *collapse* is True, all branches not containing docname will</span>
<span class="sd">        be collapsed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">toctree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">includehidden</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># For reading the following two helper function, it is useful to keep</span>
        <span class="c1"># in mind the node structure of a toctree (using HTML-like node names</span>
        <span class="c1"># for brevity):</span>
        <span class="c1">#</span>
        <span class="c1"># &lt;ul&gt;</span>
        <span class="c1">#   &lt;li&gt;</span>
        <span class="c1">#     &lt;p&gt;&lt;a&gt;&lt;/p&gt;</span>
        <span class="c1">#     &lt;p&gt;&lt;a&gt;&lt;/p&gt;</span>
        <span class="c1">#     ...</span>
        <span class="c1">#     &lt;ul&gt;</span>
        <span class="c1">#       ...</span>
        <span class="c1">#     &lt;/ul&gt;</span>
        <span class="c1">#   &lt;/li&gt;</span>
        <span class="c1"># &lt;/ul&gt;</span>
        <span class="c1">#</span>
        <span class="c1"># The transformation is made in two passes in order to avoid</span>
        <span class="c1"># interactions between marking and pruning the tree (see bug #1046).</span>

        <span class="n">toctree_ancestors</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_toctree_ancestors</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_toctree_add_classes</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Add &#39;toctree-l%d&#39; and &#39;current&#39; classes to the toctree.&quot;&quot;&quot;</span>
            <span class="k">for</span> <span class="n">subnode</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="p">(</span><span class="n">addnodes</span><span class="o">.</span><span class="n">compact_paragraph</span><span class="p">,</span>
                                        <span class="n">nodes</span><span class="o">.</span><span class="n">list_item</span><span class="p">)):</span>
                    <span class="c1"># for &lt;p&gt; and &lt;li&gt;, indicate the depth level and recurse</span>
                    <span class="n">subnode</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;toctree-l</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span>
                    <span class="n">_toctree_add_classes</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">):</span>
                    <span class="c1"># for &lt;ul&gt;, just recurse</span>
                    <span class="n">_toctree_add_classes</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">depth</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">):</span>
                    <span class="c1"># for &lt;a&gt;, identify which entries point to the current</span>
                    <span class="c1"># document and therefore may not be collapsed</span>
                    <span class="k">if</span> <span class="n">subnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">docname</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">subnode</span><span class="p">[</span><span class="s1">&#39;anchorname&#39;</span><span class="p">]:</span>
                            <span class="c1"># give the whole branch a &#39;current&#39; class</span>
                            <span class="c1"># (useful for styling it differently)</span>
                            <span class="n">branchnode</span> <span class="o">=</span> <span class="n">subnode</span>
                            <span class="k">while</span> <span class="n">branchnode</span><span class="p">:</span>
                                <span class="n">branchnode</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;current&#39;</span><span class="p">)</span>
                                <span class="n">branchnode</span> <span class="o">=</span> <span class="n">branchnode</span><span class="o">.</span><span class="n">parent</span>
                        <span class="c1"># mark the list_item as &quot;on current page&quot;</span>
                        <span class="k">if</span> <span class="n">subnode</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;iscurrent&#39;</span><span class="p">):</span>
                            <span class="c1"># but only if it&#39;s not already done</span>
                            <span class="k">return</span>
                        <span class="k">while</span> <span class="n">subnode</span><span class="p">:</span>
                            <span class="n">subnode</span><span class="p">[</span><span class="s1">&#39;iscurrent&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="n">subnode</span> <span class="o">=</span> <span class="n">subnode</span><span class="o">.</span><span class="n">parent</span>

        <span class="k">def</span> <span class="nf">_entries_from_toctree</span><span class="p">(</span><span class="n">toctreenode</span><span class="p">,</span> <span class="n">parents</span><span class="p">,</span>
                                  <span class="n">separate</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">subtree</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;Return TOC entries for a toctree node.&quot;&quot;&quot;</span>
            <span class="n">refs</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">toctreenode</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">]]</span>
            <span class="n">entries</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span> <span class="ow">in</span> <span class="n">refs</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">refdoc</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="k">if</span> <span class="n">url_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ref</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">title</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">title</span> <span class="o">=</span> <span class="n">ref</span>
                        <span class="n">reference</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">internal</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">refuri</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span> <span class="n">anchorname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                    <span class="o">*</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">title</span><span class="p">)])</span>
                        <span class="n">para</span> <span class="o">=</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">compact_paragraph</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">list_item</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">para</span><span class="p">)</span>
                        <span class="n">toc</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
                        <span class="c1"># &#39;self&#39; refers to the document from which this</span>
                        <span class="c1"># toctree originates</span>
                        <span class="n">ref</span> <span class="o">=</span> <span class="n">toctreenode</span><span class="p">[</span><span class="s1">&#39;parent&#39;</span><span class="p">]</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">title</span><span class="p">:</span>
                            <span class="n">title</span> <span class="o">=</span> <span class="n">clean_astext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">[</span><span class="n">ref</span><span class="p">])</span>
                        <span class="n">reference</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">refuri</span><span class="o">=</span><span class="n">ref</span><span class="p">,</span>
                                                    <span class="n">anchorname</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                                                    <span class="o">*</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">title</span><span class="p">)])</span>
                        <span class="n">para</span> <span class="o">=</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">compact_paragraph</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">reference</span><span class="p">)</span>
                        <span class="n">item</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">list_item</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">para</span><span class="p">)</span>
                        <span class="c1"># don&#39;t show subitems</span>
                        <span class="n">toc</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="s1">&#39;circular toctree references &#39;</span>
                                      <span class="s1">&#39;detected, ignoring: </span><span class="si">%s</span><span class="s1"> &lt;- </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>
                                      <span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="s1">&#39; &lt;- &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">parents</span><span class="p">)))</span>
                            <span class="k">continue</span>
                        <span class="n">refdoc</span> <span class="o">=</span> <span class="n">ref</span>
                        <span class="n">toc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tocs</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
                        <span class="n">maxdepth</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tocdepth&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ref</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">toctree_ancestors</span> <span class="ow">or</span> <span class="p">(</span><span class="n">prune</span> <span class="ow">and</span> <span class="n">maxdepth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_toctree_prune</span><span class="p">(</span><span class="n">toc</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">maxdepth</span><span class="p">,</span> <span class="n">collapse</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">process_only_nodes</span><span class="p">(</span><span class="n">toc</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">title</span> <span class="ow">and</span> <span class="n">toc</span><span class="o">.</span><span class="n">children</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">toc</span><span class="o">.</span><span class="n">children</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">child</span> <span class="o">=</span> <span class="n">toc</span><span class="o">.</span><span class="n">children</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">refnode</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">refnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">ref</span> <span class="ow">and</span> \
                                   <span class="ow">not</span> <span class="n">refnode</span><span class="p">[</span><span class="s1">&#39;anchorname&#39;</span><span class="p">]:</span>
                                    <span class="n">refnode</span><span class="o">.</span><span class="n">children</span> <span class="o">=</span> <span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">title</span><span class="p">)]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">toc</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                        <span class="c1"># empty toc means: no titles will show up in the toctree</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span>
                            <span class="s1">&#39;toctree contains reference to document </span><span class="si">%r</span><span class="s1"> that &#39;</span>
                            <span class="s1">&#39;doesn</span><span class="se">\&#39;</span><span class="s1">t have a title: no link will be generated&#39;</span>
                            <span class="o">%</span> <span class="n">ref</span><span class="p">,</span> <span class="n">toctreenode</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="c1"># this is raised if the included file does not exist</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span>
                        <span class="s1">&#39;toctree contains reference to nonexisting document </span><span class="si">%r</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="n">ref</span><span class="p">,</span> <span class="n">toctreenode</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># if titles_only is given, only keep the main title and</span>
                    <span class="c1"># sub-toctrees</span>
                    <span class="k">if</span> <span class="n">titles_only</span><span class="p">:</span>
                        <span class="c1"># delete everything but the toplevel title(s)</span>
                        <span class="c1"># and toctrees</span>
                        <span class="k">for</span> <span class="n">toplevel</span> <span class="ow">in</span> <span class="n">toc</span><span class="p">:</span>
                            <span class="c1"># nodes with length 1 don&#39;t have any children anyway</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">toplevel</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                                <span class="n">subtrees</span> <span class="o">=</span> <span class="n">toplevel</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">addnodes</span><span class="o">.</span><span class="n">toctree</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">subtrees</span><span class="p">:</span>
                                    <span class="n">toplevel</span><span class="p">[</span><span class="mi">1</span><span class="p">][:]</span> <span class="o">=</span> <span class="n">subtrees</span>
                                <span class="k">else</span><span class="p">:</span>
                                    <span class="n">toplevel</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="c1"># resolve all sub-toctrees</span>
                    <span class="k">for</span> <span class="n">subtocnode</span> <span class="ow">in</span> <span class="n">toc</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">addnodes</span><span class="o">.</span><span class="n">toctree</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">subtocnode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;hidden&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span>
                                <span class="ow">not</span> <span class="n">includehidden</span><span class="p">):</span>
                            <span class="n">i</span> <span class="o">=</span> <span class="n">subtocnode</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">subtocnode</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">_entries_from_toctree</span><span class="p">(</span>
                                    <span class="n">subtocnode</span><span class="p">,</span> <span class="p">[</span><span class="n">refdoc</span><span class="p">]</span> <span class="o">+</span> <span class="n">parents</span><span class="p">,</span>
                                    <span class="n">subtree</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
                                <span class="n">subtocnode</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">item</span><span class="p">)</span>
                                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">subtocnode</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">subtocnode</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">separate</span><span class="p">:</span>
                        <span class="n">entries</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">toc</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">entries</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">toc</span><span class="o">.</span><span class="n">children</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">subtree</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">separate</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">()</span>
                <span class="n">ret</span> <span class="o">+=</span> <span class="n">entries</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">ret</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">entries</span>

        <span class="n">maxdepth</span> <span class="o">=</span> <span class="n">maxdepth</span> <span class="ow">or</span> <span class="n">toctree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxdepth&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">titles_only</span> <span class="ow">and</span> <span class="n">toctree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;titlesonly&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">titles_only</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">includehidden</span> <span class="ow">and</span> <span class="n">toctree</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;includehidden&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="n">includehidden</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># NOTE: previously, this was separate=True, but that leads to artificial</span>
        <span class="c1"># separation when two or more toctree entries form a logical unit, so</span>
        <span class="c1"># separating mode is no longer used -- it&#39;s kept here for history&#39;s sake</span>
        <span class="n">tocentries</span> <span class="o">=</span> <span class="n">_entries_from_toctree</span><span class="p">(</span><span class="n">toctree</span><span class="p">,</span> <span class="p">[],</span> <span class="n">separate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tocentries</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">newnode</span> <span class="o">=</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">compact_paragraph</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">caption</span> <span class="o">=</span> <span class="n">toctree</span><span class="o">.</span><span class="n">attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;caption&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">caption</span><span class="p">:</span>
            <span class="n">newnode</span> <span class="o">+=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">caption</span><span class="p">(</span><span class="n">caption</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="o">*</span><span class="p">[</span><span class="n">nodes</span><span class="o">.</span><span class="n">Text</span><span class="p">(</span><span class="n">caption</span><span class="p">)])</span>
        <span class="n">newnode</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">tocentries</span><span class="p">)</span>
        <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;toctree&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># prune the tree to maxdepth, also set toc depth and current classes</span>
        <span class="n">_toctree_add_classes</span><span class="p">(</span><span class="n">newnode</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_toctree_prune</span><span class="p">(</span><span class="n">newnode</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">prune</span> <span class="ow">and</span> <span class="n">maxdepth</span> <span class="ow">or</span> <span class="mi">0</span><span class="p">,</span> <span class="n">collapse</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newnode</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># No titles found</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># set the target paths in the toctrees (they are not known at TOC</span>
        <span class="c1"># generation time)</span>
        <span class="k">for</span> <span class="n">refnode</span> <span class="ow">in</span> <span class="n">newnode</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">):</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">url_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">refnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]):</span>
                <span class="n">refnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_relative_uri</span><span class="p">(</span>
                    <span class="n">docname</span><span class="p">,</span> <span class="n">refnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">refnode</span><span class="p">[</span><span class="s1">&#39;anchorname&#39;</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">newnode</span>

    <span class="k">def</span> <span class="nf">resolve_references</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doctree</span><span class="p">,</span> <span class="n">fromdocname</span><span class="p">,</span> <span class="n">builder</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">addnodes</span><span class="o">.</span><span class="n">pending_xref</span><span class="p">):</span>
            <span class="n">contnode</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">()</span>
            <span class="n">newnode</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="n">typ</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;reftype&#39;</span><span class="p">]</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;reftarget&#39;</span><span class="p">]</span>
            <span class="n">refdoc</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refdoc&#39;</span><span class="p">,</span> <span class="n">fromdocname</span><span class="p">)</span>
            <span class="n">domain</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;refdomain&#39;</span> <span class="ow">in</span> <span class="n">node</span> <span class="ow">and</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;refdomain&#39;</span><span class="p">]:</span>
                    <span class="c1"># let the domain try to resolve the reference</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">domain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;refdomain&#39;</span><span class="p">]]</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="n">NoUri</span>
                    <span class="n">newnode</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">resolve_xref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refdoc</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span>
                                                  <span class="n">typ</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">)</span>
                <span class="c1"># really hardwired reference types</span>
                <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;any&#39;</span><span class="p">:</span>
                    <span class="n">newnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_any_reference</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span>
                    <span class="n">newnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_doc_reference</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;citation&#39;</span><span class="p">:</span>
                    <span class="n">newnode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_citation</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">refdoc</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">)</span>
                <span class="c1"># no new node found? try the missing-reference event</span>
                <span class="k">if</span> <span class="n">newnode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">newnode</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">emit_firstresult</span><span class="p">(</span>
                        <span class="s1">&#39;missing-reference&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">)</span>
                    <span class="c1"># still not found? warn if node wishes to be warned about or</span>
                    <span class="c1"># we are in nit-picky mode</span>
                    <span class="k">if</span> <span class="n">newnode</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_missing_reference</span><span class="p">(</span><span class="n">refdoc</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">domain</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">NoUri</span><span class="p">:</span>
                <span class="n">newnode</span> <span class="o">=</span> <span class="n">contnode</span>
            <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">(</span><span class="n">newnode</span> <span class="ow">or</span> <span class="n">contnode</span><span class="p">)</span>

        <span class="c1"># remove only-nodes that do not belong to our builder</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_only_nodes</span><span class="p">(</span><span class="n">doctree</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">fromdocname</span><span class="p">)</span>

        <span class="c1"># allow custom references to be resolved</span>
        <span class="n">builder</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">emit</span><span class="p">(</span><span class="s1">&#39;doctree-resolved&#39;</span><span class="p">,</span> <span class="n">doctree</span><span class="p">,</span> <span class="n">fromdocname</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_warn_missing_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refdoc</span><span class="p">,</span> <span class="n">typ</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">domain</span><span class="p">):</span>
        <span class="n">warn</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refwarn&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">nitpicky</span><span class="p">:</span>
            <span class="n">warn</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nitpick_ignore</span><span class="p">:</span>
                <span class="n">dtype</span> <span class="o">=</span> <span class="n">domain</span> <span class="ow">and</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">typ</span><span class="p">)</span> <span class="ow">or</span> <span class="n">typ</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">dtype</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nitpick_ignore</span><span class="p">:</span>
                    <span class="n">warn</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="c1"># for &quot;std&quot; types also try without domain name</span>
                <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">domain</span> <span class="ow">or</span> <span class="n">domain</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;std&#39;</span><span class="p">)</span> <span class="ow">and</span> \
                   <span class="p">(</span><span class="n">typ</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nitpick_ignore</span><span class="p">:</span>
                    <span class="n">warn</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">warn</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="n">domain</span> <span class="ow">and</span> <span class="n">typ</span> <span class="ow">in</span> <span class="n">domain</span><span class="o">.</span><span class="n">dangling_warnings</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">dangling_warnings</span><span class="p">[</span><span class="n">typ</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;doc&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;unknown document: </span><span class="si">%(target)s</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">typ</span> <span class="o">==</span> <span class="s1">&#39;citation&#39;</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;citation not found: </span><span class="si">%(target)s</span><span class="s1">&#39;</span>
        <span class="k">elif</span> <span class="n">node</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;refdomain&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">)</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;std&#39;</span><span class="p">):</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1"> reference target not found: </span><span class="si">%%</span><span class="s1">(target)s&#39;</span> <span class="o">%</span> \
                  <span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;refdomain&#39;</span><span class="p">],</span> <span class="n">typ</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%r</span><span class="s1"> reference target not found: </span><span class="si">%%</span><span class="s1">(target)s&#39;</span> <span class="o">%</span> <span class="n">typ</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span><span class="n">msg</span> <span class="o">%</span> <span class="p">{</span><span class="s1">&#39;target&#39;</span><span class="p">:</span> <span class="n">target</span><span class="p">},</span> <span class="n">node</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;ref&#39;</span><span class="p">,</span> <span class="n">subtype</span><span class="o">=</span><span class="n">typ</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_resolve_doc_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">):</span>
        <span class="c1"># directly reference to document by source name;</span>
        <span class="c1"># can be absolute or relative</span>
        <span class="n">docname</span> <span class="o">=</span> <span class="n">docname_join</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;refdoc&#39;</span><span class="p">],</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;reftarget&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">docname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">all_docs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;refexplicit&#39;</span><span class="p">]:</span>
                <span class="c1"># reference with explicit title</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">astext</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">caption</span> <span class="o">=</span> <span class="n">clean_astext</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="p">[</span><span class="n">docname</span><span class="p">])</span>
            <span class="n">innernode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">inline</span><span class="p">(</span><span class="n">caption</span><span class="p">,</span> <span class="n">caption</span><span class="p">)</span>
            <span class="n">innernode</span><span class="p">[</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;doc&#39;</span><span class="p">)</span>
            <span class="n">newnode</span> <span class="o">=</span> <span class="n">nodes</span><span class="o">.</span><span class="n">reference</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">internal</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">newnode</span><span class="p">[</span><span class="s1">&#39;refuri&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_relative_uri</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;refdoc&#39;</span><span class="p">],</span> <span class="n">docname</span><span class="p">)</span>
            <span class="n">newnode</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">innernode</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">newnode</span>

    <span class="k">def</span> <span class="nf">_resolve_citation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">fromdocname</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">):</span>
        <span class="n">docname</span><span class="p">,</span> <span class="n">labelid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">citations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;reftarget&#39;</span><span class="p">],</span> <span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">docname</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">newnode</span> <span class="o">=</span> <span class="n">make_refnode</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">fromdocname</span><span class="p">,</span>
                                       <span class="n">docname</span><span class="p">,</span> <span class="n">labelid</span><span class="p">,</span> <span class="n">contnode</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">newnode</span>
            <span class="k">except</span> <span class="n">NoUri</span><span class="p">:</span>
                <span class="c1"># remove the ids we added in the CitationReferences</span>
                <span class="c1"># transform since they can&#39;t be transfered to</span>
                <span class="c1"># the contnode (if it&#39;s a Text node)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">contnode</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][:]</span>
                <span class="k">raise</span>
        <span class="k">elif</span> <span class="s1">&#39;ids&#39;</span> <span class="ow">in</span> <span class="n">node</span><span class="p">:</span>
            <span class="c1"># remove ids attribute that annotated at</span>
            <span class="c1"># transforms.CitationReference.apply.</span>
            <span class="k">del</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][:]</span>

    <span class="k">def</span> <span class="nf">_resolve_any_reference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resolve reference generated by the &quot;any&quot; role.&quot;&quot;&quot;</span>
        <span class="n">refdoc</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;refdoc&#39;</span><span class="p">]</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s1">&#39;reftarget&#39;</span><span class="p">]</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="c1"># first, try resolving as :doc:</span>
        <span class="n">doc_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_resolve_doc_reference</span><span class="p">(</span><span class="n">builder</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">doc_ref</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;doc&#39;</span><span class="p">,</span> <span class="n">doc_ref</span><span class="p">))</span>
        <span class="c1"># next, do the standard domain (makes this a priority)</span>
        <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">resolve_any_xref</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">refdoc</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">domain</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">domain</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;std&#39;</span><span class="p">:</span>
                <span class="k">continue</span>  <span class="c1"># we did this one already</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">results</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">resolve_any_xref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refdoc</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span>
                                                       <span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">NotImplementedError</span><span class="p">:</span>
                <span class="c1"># the domain doesn&#39;t yet support the new interface</span>
                <span class="c1"># we have to manually collect possible references (SLOW)</span>
                <span class="k">for</span> <span class="n">role</span> <span class="ow">in</span> <span class="n">domain</span><span class="o">.</span><span class="n">roles</span><span class="p">:</span>
                    <span class="n">res</span> <span class="o">=</span> <span class="n">domain</span><span class="o">.</span><span class="n">resolve_xref</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">refdoc</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">role</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span>
                                              <span class="n">node</span><span class="p">,</span> <span class="n">contnode</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">res</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nodes</span><span class="o">.</span><span class="n">Element</span><span class="p">):</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">:</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">domain</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">role</span><span class="p">),</span> <span class="n">res</span><span class="p">))</span>
        <span class="c1"># now, see how many matches we got...</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">results</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">nice_results</span> <span class="o">=</span> <span class="s1">&#39; or &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;:</span><span class="si">%s</span><span class="s1">:&#39;</span> <span class="o">%</span> <span class="n">r</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">results</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span><span class="s1">&#39;more than one target found for </span><span class="se">\&#39;</span><span class="s1">any</span><span class="se">\&#39;</span><span class="s1"> cross-&#39;</span>
                           <span class="s1">&#39;reference </span><span class="si">%r</span><span class="s1">: could be </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">nice_results</span><span class="p">),</span>
                           <span class="n">node</span><span class="p">)</span>
        <span class="n">res_role</span><span class="p">,</span> <span class="n">newnode</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="c1"># Override &quot;any&quot; class with the actual role type to get the styling</span>
        <span class="c1"># approximately correct.</span>
        <span class="n">res_domain</span> <span class="o">=</span> <span class="n">res_role</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">newnode</span> <span class="ow">and</span> <span class="n">newnode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;classes&#39;</span><span class="p">):</span>
            <span class="n">newnode</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_domain</span><span class="p">)</span>
            <span class="n">newnode</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;classes&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res_role</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">newnode</span>

    <span class="k">def</span> <span class="nf">process_only_nodes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">doctree</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">fromdocname</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="c1"># A comment on the comment() nodes being inserted: replacing by [] would</span>
        <span class="c1"># result in a &quot;Losing ids&quot; exception if there is a target node before</span>
        <span class="c1"># the only node, so we make sure docutils can transfer the id to</span>
        <span class="c1"># something, even if it&#39;s just a comment and will lose the id anyway...</span>
        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">addnodes</span><span class="o">.</span><span class="n">only</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ret</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">tags</span><span class="o">.</span><span class="n">eval_condition</span><span class="p">(</span><span class="n">node</span><span class="p">[</span><span class="s1">&#39;expr&#39;</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn_node</span><span class="p">(</span><span class="s1">&#39;exception while evaluating only &#39;</span>
                               <span class="s1">&#39;directive expression: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">err</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span> <span class="ow">or</span> <span class="n">nodes</span><span class="o">.</span><span class="n">comment</span><span class="p">())</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">ret</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">children</span> <span class="ow">or</span> <span class="n">nodes</span><span class="o">.</span><span class="n">comment</span><span class="p">())</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">replace_self</span><span class="p">(</span><span class="n">nodes</span><span class="o">.</span><span class="n">comment</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">assign_section_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign a section number to each heading under a numbered toctree.&quot;&quot;&quot;</span>
        <span class="c1"># a list of all docnames whose section numbers changed</span>
        <span class="n">rewrite_needed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">assigned</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">old_secnumbers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc_secnumbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc_secnumbers</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">_walk_toc</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">secnums</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">titlenode</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="c1"># titlenode is the title of the document, it will get assigned a</span>
            <span class="c1"># secnumber too, so that it shows up in next/prev/parent rellinks</span>
            <span class="k">for</span> <span class="n">subnode</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">bullet_list</span><span class="p">):</span>
                    <span class="n">numstack</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                    <span class="n">_walk_toc</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">secnums</span><span class="p">,</span> <span class="n">depth</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">titlenode</span><span class="p">)</span>
                    <span class="n">numstack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                    <span class="n">titlenode</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">list_item</span><span class="p">):</span>
                    <span class="n">_walk_toc</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">secnums</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">titlenode</span><span class="p">)</span>
                    <span class="n">titlenode</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">only</span><span class="p">):</span>
                    <span class="c1"># at this stage we don&#39;t know yet which sections are going</span>
                    <span class="c1"># to be included; just include all of them, even if it leads</span>
                    <span class="c1"># to gaps in the numbering</span>
                    <span class="n">_walk_toc</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">secnums</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">titlenode</span><span class="p">)</span>
                    <span class="n">titlenode</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">compact_paragraph</span><span class="p">):</span>
                    <span class="n">numstack</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">number</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">numstack</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">number</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">secnums</span><span class="p">[</span><span class="n">subnode</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;anchorname&#39;</span><span class="p">]]</span> <span class="o">=</span> \
                        <span class="n">subnode</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;secnumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number</span>
                    <span class="k">if</span> <span class="n">titlenode</span><span class="p">:</span>
                        <span class="n">titlenode</span><span class="p">[</span><span class="s1">&#39;secnumber&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">number</span>
                        <span class="n">titlenode</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">toctree</span><span class="p">):</span>
                    <span class="n">_walk_toctree</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_walk_toctree</span><span class="p">(</span><span class="n">toctreenode</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">ref</span><span class="p">)</span> <span class="ow">in</span> <span class="n">toctreenode</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">url_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ref</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span> <span class="ow">or</span> <span class="n">ref</span> <span class="ow">in</span> <span class="n">assigned</span><span class="p">:</span>
                    <span class="c1"># don&#39;t mess with those</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">ref</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">tocs</span><span class="p">:</span>
                    <span class="n">secnums</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc_secnumbers</span><span class="p">[</span><span class="n">ref</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">assigned</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>
                    <span class="n">_walk_toc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">tocs</span><span class="p">[</span><span class="n">ref</span><span class="p">],</span> <span class="n">secnums</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">titles</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ref</span><span class="p">))</span>
                    <span class="k">if</span> <span class="n">secnums</span> <span class="o">!=</span> <span class="n">old_secnumbers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">ref</span><span class="p">):</span>
                        <span class="n">rewrite_needed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ref</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">docname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">numbered_toctrees</span><span class="p">:</span>
            <span class="n">assigned</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
            <span class="n">doctree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_doctree</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">toctreenode</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">traverse</span><span class="p">(</span><span class="n">addnodes</span><span class="o">.</span><span class="n">toctree</span><span class="p">):</span>
                <span class="n">depth</span> <span class="o">=</span> <span class="n">toctreenode</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;numbered&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">depth</span><span class="p">:</span>
                    <span class="c1"># every numbered toctree gets new numbering</span>
                    <span class="n">numstack</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">_walk_toctree</span><span class="p">(</span><span class="n">toctreenode</span><span class="p">,</span> <span class="n">depth</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rewrite_needed</span>

    <span class="k">def</span> <span class="nf">assign_figure_numbers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Assign a figure number to each figure under a numbered toctree.&quot;&quot;&quot;</span>

        <span class="n">rewrite_needed</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">assigned</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="n">old_fignumbers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc_fignumbers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">toc_fignumbers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fignum_counter</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">get_section_number</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">section</span><span class="p">):</span>
            <span class="n">anchorname</span> <span class="o">=</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">section</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">secnumbers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc_secnumbers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="p">{})</span>
            <span class="k">if</span> <span class="n">anchorname</span> <span class="ow">in</span> <span class="n">secnumbers</span><span class="p">:</span>
                <span class="n">secnum</span> <span class="o">=</span> <span class="n">secnumbers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">anchorname</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">secnum</span> <span class="o">=</span> <span class="n">secnumbers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">secnum</span> <span class="ow">or</span> <span class="nb">tuple</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">get_next_fignumber</span><span class="p">(</span><span class="n">figtype</span><span class="p">,</span> <span class="n">secnum</span><span class="p">):</span>
            <span class="n">counter</span> <span class="o">=</span> <span class="n">fignum_counter</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">figtype</span><span class="p">,</span> <span class="p">{})</span>

            <span class="n">secnum</span> <span class="o">=</span> <span class="n">secnum</span><span class="p">[:</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">numfig_secnum_depth</span><span class="p">]</span>
            <span class="n">counter</span><span class="p">[</span><span class="n">secnum</span><span class="p">]</span> <span class="o">=</span> <span class="n">counter</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">secnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">return</span> <span class="n">secnum</span> <span class="o">+</span> <span class="p">(</span><span class="n">counter</span><span class="p">[</span><span class="n">secnum</span><span class="p">],)</span>

        <span class="k">def</span> <span class="nf">register_fignumber</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">secnum</span><span class="p">,</span> <span class="n">figtype</span><span class="p">,</span> <span class="n">fignode</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">toc_fignumbers</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">fignumbers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">toc_fignumbers</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">figtype</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">figure_id</span> <span class="o">=</span> <span class="n">fignode</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">fignumbers</span><span class="p">[</span><span class="n">figure_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_next_fignumber</span><span class="p">(</span><span class="n">figtype</span><span class="p">,</span> <span class="n">secnum</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_walk_doctree</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">,</span> <span class="n">secnum</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">subnode</span> <span class="ow">in</span> <span class="n">doctree</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">nodes</span><span class="o">.</span><span class="n">section</span><span class="p">):</span>
                    <span class="n">next_secnum</span> <span class="o">=</span> <span class="n">get_section_number</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">subnode</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">next_secnum</span><span class="p">:</span>
                        <span class="n">_walk_doctree</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">subnode</span><span class="p">,</span> <span class="n">next_secnum</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_walk_doctree</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">subnode</span><span class="p">,</span> <span class="n">secnum</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">subnode</span><span class="p">,</span> <span class="n">addnodes</span><span class="o">.</span><span class="n">toctree</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">title</span><span class="p">,</span> <span class="n">subdocname</span> <span class="ow">in</span> <span class="n">subnode</span><span class="p">[</span><span class="s1">&#39;entries&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">url_re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">subdocname</span><span class="p">)</span> <span class="ow">or</span> <span class="n">subdocname</span> <span class="o">==</span> <span class="s1">&#39;self&#39;</span><span class="p">:</span>
                            <span class="c1"># don&#39;t mess with those</span>
                            <span class="k">continue</span>

                        <span class="n">_walk_doc</span><span class="p">(</span><span class="n">subdocname</span><span class="p">,</span> <span class="n">secnum</span><span class="p">)</span>

                    <span class="k">continue</span>

                <span class="n">figtype</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">domains</span><span class="p">[</span><span class="s1">&#39;std&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">get_figtype</span><span class="p">(</span><span class="n">subnode</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">figtype</span> <span class="ow">and</span> <span class="n">subnode</span><span class="p">[</span><span class="s1">&#39;ids&#39;</span><span class="p">]:</span>
                    <span class="n">register_fignumber</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">secnum</span><span class="p">,</span> <span class="n">figtype</span><span class="p">,</span> <span class="n">subnode</span><span class="p">)</span>

                <span class="n">_walk_doctree</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">subnode</span><span class="p">,</span> <span class="n">secnum</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">_walk_doc</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">secnum</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">docname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">assigned</span><span class="p">:</span>
                <span class="n">assigned</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
                <span class="n">doctree</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_doctree</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>
                <span class="n">_walk_doctree</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">doctree</span><span class="p">,</span> <span class="n">secnum</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">numfig</span><span class="p">:</span>
            <span class="n">_walk_doc</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_doc</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">docname</span><span class="p">,</span> <span class="n">fignums</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toc_fignumbers</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">fignums</span> <span class="o">!=</span> <span class="n">old_fignumbers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">docname</span><span class="p">):</span>
                    <span class="n">rewrite_needed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rewrite_needed</span>

    <span class="k">def</span> <span class="nf">create_index</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">builder</span><span class="p">,</span> <span class="n">group_entries</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">_fixre</span><span class="o">=</span><span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="s1">r&#39;(.*) ([(][^()]*[)])&#39;</span><span class="p">)):</span>
        <span class="sd">&quot;&quot;&quot;Create the real index from the collected index entries.&quot;&quot;&quot;</span>
        <span class="n">new</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">add_entry</span><span class="p">(</span><span class="n">word</span><span class="p">,</span> <span class="n">subword</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dic</span><span class="o">=</span><span class="n">new</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
            <span class="c1"># Force the word to be unicode if it&#39;s a ASCII bytestring.</span>
            <span class="c1"># This will solve problems with unicode normalization later.</span>
            <span class="c1"># For instance the RFC role will add bytestrings at the moment</span>
            <span class="n">word</span> <span class="o">=</span> <span class="n">text_type</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="n">entry</span> <span class="o">=</span> <span class="n">dic</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">entry</span><span class="p">:</span>
                <span class="n">dic</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="n">entry</span> <span class="o">=</span> <span class="p">[[],</span> <span class="p">{},</span> <span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">subword</span><span class="p">:</span>
                <span class="n">add_entry</span><span class="p">(</span><span class="n">subword</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="n">link</span><span class="p">,</span> <span class="n">dic</span><span class="o">=</span><span class="n">entry</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">key</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">link</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">uri</span> <span class="o">=</span> <span class="n">builder</span><span class="o">.</span><span class="n">get_relative_uri</span><span class="p">(</span><span class="s1">&#39;genindex&#39;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">tid</span>
                <span class="k">except</span> <span class="n">NoUri</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># maintain links in sorted/deterministic order</span>
                    <span class="n">bisect</span><span class="o">.</span><span class="n">insort</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">main</span><span class="p">,</span> <span class="n">uri</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">entries</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">indexentries</span><span class="p">):</span>
            <span class="c1"># new entry types must be listed in directives/other.py!</span>
            <span class="k">for</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">main</span><span class="p">,</span> <span class="n">index_key</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;single&#39;</span><span class="p">:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">entry</span><span class="p">,</span> <span class="n">subentry</span> <span class="o">=</span> <span class="n">split_into</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                            <span class="n">entry</span><span class="p">,</span> <span class="o">=</span> <span class="n">split_into</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s1">&#39;single&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                            <span class="n">subentry</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                        <span class="n">add_entry</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">subentry</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">index_key</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;pair&#39;</span><span class="p">:</span>
                        <span class="n">first</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">split_into</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;pair&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">add_entry</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">index_key</span><span class="p">)</span>
                        <span class="n">add_entry</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="n">first</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">index_key</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;triple&#39;</span><span class="p">:</span>
                        <span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="p">,</span> <span class="n">third</span> <span class="o">=</span> <span class="n">split_into</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="s1">&#39;triple&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">add_entry</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">second</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">third</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">index_key</span><span class="p">)</span>
                        <span class="n">add_entry</span><span class="p">(</span><span class="n">second</span><span class="p">,</span> <span class="n">third</span><span class="o">+</span><span class="s1">&#39;, &#39;</span><span class="o">+</span><span class="n">first</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">index_key</span><span class="p">)</span>
                        <span class="n">add_entry</span><span class="p">(</span><span class="n">third</span><span class="p">,</span> <span class="n">first</span><span class="o">+</span><span class="s1">&#39; &#39;</span><span class="o">+</span><span class="n">second</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">index_key</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;see&#39;</span><span class="p">:</span>
                        <span class="n">first</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">split_into</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;see&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">add_entry</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;see </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">second</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">key</span><span class="o">=</span><span class="n">index_key</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="nb">type</span> <span class="o">==</span> <span class="s1">&#39;seealso&#39;</span><span class="p">:</span>
                        <span class="n">first</span><span class="p">,</span> <span class="n">second</span> <span class="o">=</span> <span class="n">split_into</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="s1">&#39;see&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">add_entry</span><span class="p">(</span><span class="n">first</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;see also </span><span class="si">%s</span><span class="s1">&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="n">second</span><span class="p">,</span> <span class="n">link</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                  <span class="n">key</span><span class="o">=</span><span class="n">index_key</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="s1">&#39;unknown index entry type </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="nb">type</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">err</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>

        <span class="c1"># sort the index entries; put all symbols at the front, even those</span>
        <span class="c1"># following the letters in ASCII, this is where the chr(127) comes from</span>
        <span class="k">def</span> <span class="nf">keyfunc</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="n">lcletters</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_lowercase</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="n">lckey</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFD&#39;</span><span class="p">,</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">lckey</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="n">lcletters</span><span class="p">:</span>
                <span class="n">lckey</span> <span class="o">=</span> <span class="nb">chr</span><span class="p">(</span><span class="mi">127</span><span class="p">)</span> <span class="o">+</span> <span class="n">lckey</span>
            <span class="c1"># ensure a determinstic order *within* letters by also sorting on</span>
            <span class="c1"># the entry itself</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">lckey</span><span class="p">,</span> <span class="n">entry</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">newlist</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">new</span><span class="o">.</span><span class="n">items</span><span class="p">(),</span> <span class="n">key</span><span class="o">=</span><span class="n">keyfunc</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">group_entries</span><span class="p">:</span>
            <span class="c1"># fixup entries: transform</span>
            <span class="c1">#   func() (in module foo)</span>
            <span class="c1">#   func() (in module bar)</span>
            <span class="c1"># into</span>
            <span class="c1">#   func()</span>
            <span class="c1">#     (in module foo)</span>
            <span class="c1">#     (in module bar)</span>
            <span class="n">oldkey</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">oldsubitems</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">newlist</span><span class="p">):</span>
                <span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="n">targets</span><span class="p">,</span> <span class="n">subitems</span><span class="p">,</span> <span class="n">_key</span><span class="p">)</span> <span class="o">=</span> <span class="n">newlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="c1"># cannot move if it has subitems; structure gets too complex</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">subitems</span><span class="p">:</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="n">_fixre</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">oldkey</span> <span class="o">==</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">):</span>
                            <span class="c1"># prefixes match: add entry as subitem of the</span>
                            <span class="c1"># previous entry</span>
                            <span class="n">oldsubitems</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="p">[[],</span> <span class="p">{},</span> <span class="n">_key</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span>\
                                <span class="n">extend</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span>
                            <span class="k">del</span> <span class="n">newlist</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">continue</span>
                        <span class="n">oldkey</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">oldkey</span> <span class="o">=</span> <span class="n">key</span>
                <span class="n">oldsubitems</span> <span class="o">=</span> <span class="n">subitems</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># group the entries by letter</span>
        <span class="k">def</span> <span class="nf">keyfunc2</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">letters</span><span class="o">=</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">):</span>
            <span class="c1"># hack: mutating the subitems dicts to a list in the keyfunc</span>
            <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">item</span>
            <span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">((</span><span class="n">si</span><span class="p">,</span> <span class="n">se</span><span class="p">)</span> <span class="k">for</span> <span class="p">(</span><span class="n">si</span><span class="p">,</span> <span class="p">(</span><span class="n">se</span><span class="p">,</span> <span class="n">void</span><span class="p">,</span> <span class="n">void</span><span class="p">))</span> <span class="ow">in</span> <span class="n">iteritems</span><span class="p">(</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">if</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># now calculate the key</span>
                <span class="n">letter</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFD&#39;</span><span class="p">,</span> <span class="n">k</span><span class="p">[</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">letter</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">letter</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># get all other symbols under one heading</span>
                    <span class="k">return</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Symbols&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[(</span><span class="n">key_</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">group</span><span class="p">))</span>
                <span class="k">for</span> <span class="p">(</span><span class="n">key_</span><span class="p">,</span> <span class="n">group</span><span class="p">)</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">newlist</span><span class="p">,</span> <span class="n">keyfunc2</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">collect_relations</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">traversed</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">def</span> <span class="nf">traverse_toctree</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">docname</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">parent</span> <span class="o">==</span> <span class="n">docname</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="s1">&#39;self referenced toctree found. Ignored.&#39;</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="c1"># traverse toctree by pre-order</span>
            <span class="k">yield</span> <span class="n">parent</span><span class="p">,</span> <span class="n">docname</span>
            <span class="n">traversed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">toctree_includes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">docname</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]):</span>
                <span class="k">for</span> <span class="n">subparent</span><span class="p">,</span> <span class="n">subdocname</span> <span class="ow">in</span> <span class="n">traverse_toctree</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="n">child</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">subdocname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">traversed</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">subparent</span><span class="p">,</span> <span class="n">subdocname</span>
                        <span class="n">traversed</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">subdocname</span><span class="p">)</span>

        <span class="n">relations</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">docnames</span> <span class="o">=</span> <span class="n">traverse_toctree</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_doc</span><span class="p">)</span>
        <span class="n">prevdoc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">parent</span><span class="p">,</span> <span class="n">docname</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">docnames</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nextparent</span><span class="p">,</span> <span class="n">nextdoc</span> <span class="ow">in</span> <span class="n">docnames</span><span class="p">:</span>
            <span class="n">relations</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent</span><span class="p">,</span> <span class="n">prevdoc</span><span class="p">,</span> <span class="n">nextdoc</span><span class="p">]</span>
            <span class="n">prevdoc</span> <span class="o">=</span> <span class="n">docname</span>
            <span class="n">docname</span> <span class="o">=</span> <span class="n">nextdoc</span>
            <span class="n">parent</span> <span class="o">=</span> <span class="n">nextparent</span>

        <span class="n">relations</span><span class="p">[</span><span class="n">docname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">parent</span><span class="p">,</span> <span class="n">prevdoc</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">relations</span>

    <span class="k">def</span> <span class="nf">check_consistency</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do consistency checks.&quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">docname</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">all_docs</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">docname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">files_to_rebuild</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">docname</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">master_doc</span><span class="p">:</span>
                    <span class="c1"># the master file is not included anywhere ;)</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">docname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">included</span><span class="p">:</span>
                    <span class="c1"># the document is included from other documents</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="s1">&#39;orphan&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">docname</span><span class="p">]:</span>
                    <span class="k">continue</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="n">docname</span><span class="p">,</span> <span class="s1">&#39;document isn</span><span class="se">\&#39;</span><span class="s1">t included in any toctree&#39;</span><span class="p">)</span></div>
</pre></div>

           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, tw.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>